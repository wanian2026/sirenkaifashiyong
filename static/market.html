<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时行情 - 加密货币交易系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=stylesheet" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .price-up {
            color: #10b981;
            animation: flashGreen 0.3s ease;
        }

        .price-down {
            color: #ef4444;
            animation: flashRed 0.3s ease;
        }

        @keyframes flashGreen {
            0% { background-color: rgba(16, 185, 129, 0.2); }
            100% { background-color: transparent; }
        }

        @keyframes flashRed {
            0% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: transparent; }
        }

        .loading-spinner {
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .market-row:hover {
            background-color: rgba(102, 126, 234, 0.1);
            cursor: pointer;
        }

        .selected-row {
            background-color: rgba(102, 126, 234, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="goBack()" class="mr-4 p-2 hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold">实时行情</h1>
                </div>
                <div class="flex items-center gap-4">
                    <select id="exchangeSelect" onchange="changeExchange()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm">
                        <option value="binance">币安 (Binance)</option>
                        <option value="okx">OKX</option>
                        <option value="huobi">火币 (Huobi)</option>
                    </select>
                    <div id="connectionStatus" class="flex items-center text-sm">
                        <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span>
                        <span>连接中...</span>
                    </div>
                    <div id="lastUpdate" class="text-xs text-gray-400"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Filter Bar -->
    <div class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center gap-4">
                <div class="flex items-center">
                    <label class="text-sm text-gray-400 mr-2">搜索:</label>
                    <input type="text" id="searchInput" onkeyup="filterMarkets()" 
                           placeholder="输入交易对名称..." 
                           class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm w-64">
                </div>
                <div class="flex items-center">
                    <label class="text-sm text-gray-400 mr-2">排序:</label>
                    <select id="sortBy" onchange="sortMarkets()" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm">
                        <option value="name">名称</option>
                        <option value="price">价格</option>
                        <option value="change">涨跌幅</option>
                        <option value="volume">成交量</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <label class="text-sm text-gray-400 mr-2">方向:</label>
                    <select id="sortOrder" onchange="sortMarkets()" class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-sm">
                        <option value="desc">降序</option>
                        <option value="asc">升序</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Market Table -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-gray-800 rounded-xl overflow-hidden">
            <!-- Table Header -->
            <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-gray-700 text-xs font-semibold text-gray-400 uppercase tracking-wider">
                <div class="col-span-3">交易对</div>
                <div class="col-span-2 text-right">最新价</div>
                <div class="col-span-2 text-right">24h涨跌</div>
                <div class="col-span-2 text-right">24h最高</div>
                <div class="col-span-2 text-right">24h最低</div>
                <div class="col-span-1 text-right">成交量</div>
            </div>

            <!-- Table Body -->
            <div id="marketTable" class="divide-y divide-gray-700">
                <!-- Loading State -->
                <div id="loadingState" class="flex items-center justify-center py-12">
                    <div class="loading-spinner"></div>
                    <span class="ml-3 text-gray-400">加载中...</span>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden flex items-center justify-center py-12">
                    <span class="text-gray-400">暂无数据</span>
                </div>
            </div>
        </div>

        <!-- Selected Symbol Info -->
        <div id="selectedInfo" class="hidden mt-6 bg-gray-800 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" id="selectedSymbol">BTC/USDT</h2>
                <button onclick="viewTrading()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm font-medium">
                    查看交易
                </button>
            </div>
            <div class="grid grid-cols-4 gap-6">
                <div>
                    <p class="text-gray-400 text-xs mb-1">最新价格</p>
                    <p class="text-2xl font-bold" id="selectedPrice">$0.00</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs mb-1">24h涨跌</p>
                    <p class="text-lg font-semibold" id="selectedChange">+0.00%</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs mb-1">24h成交量</p>
                    <p class="text-lg font-semibold" id="selectedVolume">0</p>
                </div>
                <div>
                    <p class="text-gray-400 text-xs mb-1">24h成交额</p>
                    <p class="text-lg font-semibold" id="selectedQuoteVolume">$0</p>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局变量
        let allMarkets = [];
        let currentPrices = {};
        let selectedSymbol = null;
        let refreshInterval = null;
        let previousPrices = {};

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadMarkets();
            startAutoRefresh();
        });

        // 加载市场列表
        async function loadMarkets() {
            try {
                showLoading(true);
                
                // 获取交易对列表
                const pairsResponse = await axios.get('/api/exchange/pairs');
                
                if (pairsResponse.data.success) {
                    allMarkets = pairsResponse.data.data;
                    
                    // 获取所有交易对的实时行情
                    const symbols = allMarkets.map(m => m.symbol).join(',');
                    await loadTickers(symbols);
                    
                    renderMarketTable();
                    updateConnectionStatus(true);
                    hideLoading();
                }
            } catch (error) {
                console.error('加载市场列表失败:', error);
                updateConnectionStatus(false);
                hideLoading();
                showError('加载数据失败，请检查网络连接');
            }
        }

        // 加载行情数据
        async function loadTickers(symbols) {
            try {
                const tickerResponse = await axios.get('/api/exchange/tickers/batch', {
                    params: { symbols: symbols }
                });

                if (tickerResponse.data.success) {
                    tickerResponse.data.data.forEach(ticker => {
                        currentPrices[ticker.symbol] = ticker;
                    });
                    updateLastUpdateTime();
                }
            } catch (error) {
                console.error('加载行情数据失败:', error);
            }
        }

        // 渲染市场表格
        function renderMarketTable() {
            const table = document.getElementById('marketTable');
            const emptyState = document.getElementById('emptyState');

            if (allMarkets.length === 0) {
                table.innerHTML = '';
                table.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            // 过滤和排序
            let filteredMarkets = filterAndSortMarkets();

            let html = '';
            filteredMarkets.forEach(market => {
                const ticker = currentPrices[market.symbol] || {};
                const price = ticker.last || 0;
                const change = ticker.percentage || 0;
                const high = ticker.high || 0;
                const low = ticker.low || 0;
                const volume = ticker.volume || 0;

                // 比较价格变化
                const prevPrice = previousPrices[market.symbol] || price;
                let priceClass = '';
                if (price > prevPrice) {
                    priceClass = 'price-up';
                } else if (price < prevPrice) {
                    priceClass = 'price-down';
                }

                // 涨跌颜色
                const changeClass = change >= 0 ? 'text-green-500' : 'text-red-500';
                const changePrefix = change >= 0 ? '+' : '';

                // 选中状态
                const selectedClass = selectedSymbol === market.symbol ? 'selected-row' : '';

                html += `
                    <div class="market-row grid grid-cols-12 gap-4 px-6 py-3 ${selectedClass}" 
                         onclick="selectSymbol('${market.symbol}')">
                        <div class="col-span-3">
                            <div class="font-medium text-sm">${market.symbol}</div>
                            <div class="text-xs text-gray-400">${market.name || market.base}</div>
                        </div>
                        <div class="col-span-2 text-right">
                            <div class="font-medium text-sm ${priceClass}" data-symbol="${market.symbol}">${formatPrice(price)}</div>
                        </div>
                        <div class="col-span-2 text-right">
                            <div class="text-sm ${changeClass}">${changePrefix}${change.toFixed(2)}%</div>
                        </div>
                        <div class="col-span-2 text-right">
                            <div class="text-sm">${formatPrice(high)}</div>
                        </div>
                        <div class="col-span-2 text-right">
                            <div class="text-sm">${formatPrice(low)}</div>
                        </div>
                        <div class="col-span-1 text-right">
                            <div class="text-sm">${formatVolume(volume)}</div>
                        </div>
                    </div>
                `;
            });

            table.innerHTML = html;

            // 保存当前价格用于下次比较
            previousPrices = { ...currentPrices };
        }

        // 过滤和排序
        function filterAndSortMarkets() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // 过滤
            let filtered = allMarkets.filter(market => 
                market.symbol.toLowerCase().includes(searchTerm) ||
                (market.name && market.name.toLowerCase().includes(searchTerm))
            );

            // 排序
            filtered.sort((a, b) => {
                let valueA, valueB;

                switch (sortBy) {
                    case 'price':
                        valueA = currentPrices[a.symbol]?.last || 0;
                        valueB = currentPrices[b.symbol]?.last || 0;
                        break;
                    case 'change':
                        valueA = currentPrices[a.symbol]?.percentage || 0;
                        valueB = currentPrices[b.symbol]?.percentage || 0;
                        break;
                    case 'volume':
                        valueA = currentPrices[a.symbol]?.volume || 0;
                        valueB = currentPrices[b.symbol]?.volume || 0;
                        break;
                    default: // name
                        valueA = a.symbol;
                        valueB = b.symbol;
                }

                if (sortOrder === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });

            return filtered;
        }

        // 选择交易对
        function selectSymbol(symbol) {
            selectedSymbol = symbol;
            const ticker = currentPrices[symbol];

            // 更新选中状态
            renderMarketTable();

            // 显示选中信息
            if (ticker) {
                document.getElementById('selectedInfo').classList.remove('hidden');
                document.getElementById('selectedSymbol').textContent = symbol;
                document.getElementById('selectedPrice').textContent = formatPrice(ticker.last);
                
                const change = ticker.percentage || 0;
                const changeEl = document.getElementById('selectedChange');
                changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                changeEl.className = `text-lg font-semibold ${change >= 0 ? 'text-green-500' : 'text-red-500'}`;
                
                document.getElementById('selectedVolume').textContent = formatVolume(ticker.volume);
                document.getElementById('selectedQuoteVolume').textContent = '$' + formatVolume(ticker.quoteVolume);
            }
        }

        // 查看交易页面
        function viewTrading() {
            if (selectedSymbol) {
                window.location.href = `/static/trading.html?symbol=${encodeURIComponent(selectedSymbol)}`;
            }
        }

        // 自动刷新
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                try {
                    const symbols = allMarkets.map(m => m.symbol).join(',');
                    await loadTickers(symbols);
                    renderMarketTable();
                    
                    // 如果有选中的交易对，更新选中信息
                    if (selectedSymbol && currentPrices[selectedSymbol]) {
                        selectSymbol(selectedSymbol);
                    }
                } catch (error) {
                    console.error('刷新行情失败:', error);
                }
            }, 3000); // 每3秒刷新一次
        }

        // 过滤市场
        function filterMarkets() {
            renderMarketTable();
        }

        // 排序市场
        function sortMarkets() {
            renderMarketTable();
        }

        // 切换交易所
        function changeExchange() {
            // 清空当前数据
            allMarkets = [];
            currentPrices = {};
            selectedSymbol = null;
            document.getElementById('selectedInfo').classList.add('hidden');
            
            // 重新加载
            loadMarkets();
        }

        // 格式化价格
        function formatPrice(price) {
            if (!price) return '$0.00';
            if (price >= 1) {
                return '$' + price.toFixed(2);
            } else {
                return '$' + price.toFixed(6);
            }
        }

        // 格式化成交量
        function formatVolume(volume) {
            if (!volume) return '0';
            if (volume >= 1000000) {
                return (volume / 1000000).toFixed(2) + 'M';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(2) + 'K';
            }
            return volume.toFixed(2);
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                    <span class="text-green-500">已连接</span>
                `;
            } else {
                status.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>
                    <span class="text-red-500">连接失败</span>
                `;
            }
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = '更新于: ' + now.toLocaleTimeString();
        }

        // 显示/隐藏加载状态
        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            if (show) {
                loadingState.classList.remove('hidden');
            } else {
                loadingState.classList.add('hidden');
            }
        }

        function hideLoading() {
            const loadingState = document.getElementById('loadingState');
            loadingState.classList.add('hidden');
        }

        // 显示错误信息
        function showError(message) {
            const table = document.getElementById('marketTable');
            table.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <p class="text-red-500 mb-2">${message}</p>
                        <button onclick="loadMarkets()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-sm">
                            重试
                        </button>
                    </div>
                </div>
            `;
        }

        // 返回
        function goBack() {
            window.location.href = '/static/ultra_minimal.html';
        }
    </script>
</body>
</html>
