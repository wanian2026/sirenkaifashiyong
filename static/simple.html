<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ç®¡ç† - åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8a 100%);
            border: none;
        }
        .status-running {
            color: #28a745;
            font-weight: bold;
        }
        .status-stopped {
            color: #dc3545;
            font-weight: bold;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                ğŸš€ åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ v1.0.0
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/static/management.html">å®Œæ•´ç®¡ç†</a>
                <a class="nav-link" href="#" onclick="logout()">é€€å‡º</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="container mt-4">
        <h2 class="text-center mb-4">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h2>

        <!-- å¿«æ·æ“ä½œ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">å¿«æ·æ“ä½œ</div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="createBot()">â• åˆ›å»ºæœºå™¨äºº</button>
                            <button class="btn btn-success" onclick="startAllBots()">â–¶ï¸ å¯åŠ¨æ‰€æœ‰</button>
                            <button class="btn btn-danger" onclick="stopAllBots()">â¹ï¸ åœæ­¢æ‰€æœ‰</button>
                            <button class="btn btn-warning" onclick="testConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">ç³»ç»ŸçŠ¶æ€</div>
                    <div class="card-body">
                        <p><strong>APIæœåŠ¡:</strong> <span class="text-success">âœ“ è¿è¡Œä¸­</span></p>
                        <p><strong>æ•°æ®åº“:</strong> <span class="text-success">âœ“ æ­£å¸¸</span></p>
                        <p><strong>æœºå™¨äººæ•°:</strong> <span id="botCount">-</span></p>
                        <p><strong>è¿è¡Œä¸­:</strong> <span id="runningCount" class="status-running">-</span></p>
                        <p><strong>æ€»ç›ˆäº:</strong> <span id="totalPnL">-</span></p>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">å¿«é€Ÿè®¿é—®</div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/static/bots.html" class="btn btn-outline-primary">ğŸ¤– æœºå™¨äººç®¡ç†</a>
                            <a href="/static/trading.html" class="btn btn-outline-primary">ğŸ“ˆ äº¤æ˜“è®°å½•</a>
                            <a href="/static/analytics.html" class="btn btn-outline-primary">ğŸ“Š æ•°æ®åˆ†æ</a>
                            <a href="/static/settings.html" class="btn btn-outline-primary">âš™ï¸ ç³»ç»Ÿè®¾ç½®</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœºå™¨äººåˆ—è¡¨ -->
        <div class="card">
            <div class="card-header">ğŸ¤– æœºå™¨äººåˆ—è¡¨</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>åç§°</th>
                                <th>ç­–ç•¥</th>
                                <th>çŠ¶æ€</th>
                                <th>ç›ˆäº</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="botList">
                            <tr>
                                <td colspan="6" class="text-center">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘äº¤æ˜“ -->
        <div class="card">
            <div class="card-header">ğŸ“‹ æœ€è¿‘äº¤æ˜“</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>æ—¶é—´</th>
                                <th>äº¤æ˜“å¯¹</th>
                                <th>æ–¹å‘</th>
                                <th>ä»·æ ¼</th>
                                <th>æ•°é‡</th>
                                <th>ç›ˆäº</th>
                            </tr>
                        </thead>
                        <tbody id="tradeList">
                            <tr>
                                <td colspan="6" class="text-center">æš‚æ— äº¤æ˜“è®°å½•</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="toast" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toastBody" class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000/api';

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toastBody');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.textContent = message;
            toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // åˆ›å»ºæœºå™¨äºº
        function createBot() {
            window.location.href = '/static/bots.html?mode=create';
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                await axios.get(`${API_BASE}/exchange/test`);
                showToast('è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                showToast('è¿æ¥å¤±è´¥ï¼š' + (error.response?.data?.detail || error.message), 'danger');
            }
        }

        // å¯åŠ¨æ‰€æœ‰æœºå™¨äºº
        async function startAllBots() {
            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/start-all`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                showToast('å·²å¯åŠ¨æ‰€æœ‰æœºå™¨äºº');
                loadBots();
            } catch (error) {
                showToast('å¯åŠ¨å¤±è´¥ï¼š' + (error.response?.data?.detail || error.message), 'danger');
            }
        }

        // åœæ­¢æ‰€æœ‰æœºå™¨äºº
        async function stopAllBots() {
            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/stop-all`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                showToast('å·²åœæ­¢æ‰€æœ‰æœºå™¨äºº');
                loadBots();
            } catch (error) {
                showToast('åœæ­¢å¤±è´¥ï¼š' + (error.response?.data?.detail || error.message), 'danger');
            }
        }

        // é€€å‡º
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/static/auth.html';
        }

        // åŠ è½½æœºå™¨äººåˆ—è¡¨
        async function loadBots() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/bots/`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const bots = response.data || [];

                // æ›´æ–°ç»Ÿè®¡
                document.getElementById('botCount').textContent = bots.length;
                document.getElementById('runningCount').textContent = bots.filter(b => b.status === 'running').length;

                const totalPnL = bots.reduce((sum, b) => sum + (b.total_pnl || 0), 0);
                const pnlEl = document.getElementById('totalPnL');
                pnlEl.textContent = '$' + totalPnL.toFixed(2);
                pnlEl.className = totalPnL >= 0 ? 'profit-positive' : 'profit-negative';

                // æ›´æ–°åˆ—è¡¨
                const tbody = document.getElementById('botList');
                if (bots.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">æš‚æ— æœºå™¨äºº</td></tr>';
                    return;
                }

                tbody.innerHTML = bots.map(bot => `
                    <tr>
                        <td>${bot.id}</td>
                        <td><strong>${bot.name}</strong></td>
                        <td>${bot.strategy_type}</td>
                        <td class="${bot.status === 'running' ? 'status-running' : 'status-stopped'}">
                            ${bot.status === 'running' ? 'â— è¿è¡Œä¸­' : 'â— å·²åœæ­¢'}
                        </td>
                        <td class="${bot.total_pnl >= 0 ? 'profit-positive' : 'profit-negative'}">
                            $${(bot.total_pnl || 0).toFixed(2)}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="toggleBot(${bot.id})">
                                ${bot.status === 'running' ? 'åœæ­¢' : 'å¯åŠ¨'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æœºå™¨äººå¤±è´¥:', error);
                document.getElementById('botList').innerHTML = '<tr><td colspan="6" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // åˆ‡æ¢æœºå™¨äººçŠ¶æ€
        async function toggleBot(id) {
            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/${id}/toggle`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                showToast('æ“ä½œæˆåŠŸ');
                loadBots();
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥ï¼š' + (error.response?.data?.detail || error.message), 'danger');
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            loadBots();
        });
    </script>
</body>
</html>
