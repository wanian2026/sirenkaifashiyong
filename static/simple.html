<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç®€ç®¡ç† - åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        }
        body {
            background: #fff;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .tabs {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }
        .tab-btn.active {
            background: #000;
            color: #fff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .btn {
            padding: 5px 10px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .btn:hover {
            background: #000;
            color: #fff;
        }
        .btn-primary {
            background: #000;
            color: #fff;
        }
        .status-running {
            color: #28a745;
        }
        .status-stopped {
            color: #dc3545;
        }
        .profit-positive {
            color: #28a745;
        }
        .profit-negative {
            color: #dc3545;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-box {
            border: 1px solid #ddd;
            padding: 15px;
            text-align: center;
        }
        .stat-box strong {
            display: block;
            font-size: 24px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            margin: 50px auto;
            max-width: 500px;
            border: 1px solid #000;
        }
        .modal-buttons {
            margin-top: 20px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ - æç®€ç®¡ç†</h1>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">æ¦‚è§ˆ</button>
            <button class="tab-btn" onclick="showTab('bots')">æœºå™¨äºº</button>
            <button class="tab-btn" onclick="showTab('trades')">äº¤æ˜“</button>
            <button class="tab-btn" onclick="showTab('orders')">è®¢å•</button>
            <button class="tab-btn" onclick="showTab('backtest')">å›æµ‹</button>
            <button class="tab-btn" onclick="showTab('analytics')">åˆ†æ</button>
        </div>

        <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-box">
                    <strong id="botCount">-</strong>
                    æœºå™¨äººæ€»æ•°
                </div>
                <div class="stat-box">
                    <strong id="runningCount" class="status-running">-</strong>
                    è¿è¡Œä¸­
                </div>
                <div class="stat-box">
                    <strong id="totalPnL">-</strong>
                    æ€»ç›ˆäº($)
                </div>
                <div class="stat-box">
                    <strong id="totalTrades">-</strong>
                    äº¤æ˜“æ€»æ•°
                </div>
            </div>

            <button class="btn btn-primary" onclick="createBot()">â• åˆ›å»ºæœºå™¨äºº</button>
            <button class="btn" onclick="startAllBots()">â–¶ï¸ å¯åŠ¨æ‰€æœ‰</button>
            <button class="btn" onclick="stopAllBots()">â¹ï¸ åœæ­¢æ‰€æœ‰</button>

            <h2>ç³»ç»ŸçŠ¶æ€</h2>
            <table>
                <tr><td>APIæœåŠ¡</td><td class="status-running">âœ“ è¿è¡Œä¸­</td></tr>
                <tr><td>æ•°æ®åº“</td><td class="status-running">âœ“ æ­£å¸¸</td></tr>
                <tr><td>Redisç¼“å­˜</td><td class="status-stopped">âœ— æœªå¯ç”¨</td></tr>
            </table>

            <h2>æœ€è¿‘äº¤æ˜“</h2>
            <table id="recentTrades">
                <thead>
                    <tr><th>æ—¶é—´</th><th>äº¤æ˜“å¯¹</th><th>æ–¹å‘</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>ç›ˆäº</th></tr>
                </thead>
                <tbody>
                    <tr><td colspan="6">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- æœºå™¨äººæ ‡ç­¾é¡µ -->
        <div id="bots" class="tab-content">
            <button class="btn btn-primary" onclick="createBot()">â• åˆ›å»ºæœºå™¨äºº</button>

            <table>
                <thead>
                    <tr><th>ID</th><th>åç§°</th><th>ç­–ç•¥</th><th>äº¤æ˜“å¯¹</th><th>çŠ¶æ€</th><th>ç›ˆäº</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody id="botList">
                    <tr><td colspan="7">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- äº¤æ˜“æ ‡ç­¾é¡µ -->
        <div id="trades" class="tab-content">
            <table>
                <thead>
                    <tr><th>æ—¶é—´</th><th>æœºå™¨äºº</th><th>äº¤æ˜“å¯¹</th><th>æ–¹å‘</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>ç›ˆäº</th></tr>
                </thead>
                <tbody id="tradeList">
                    <tr><td colspan="7">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- è®¢å•æ ‡ç­¾é¡µ -->
        <div id="orders" class="tab-content">
            <table>
                <thead>
                    <tr><th>æ—¶é—´</th><th>æœºå™¨äºº</th><th>äº¤æ˜“å¯¹</th><th>æ–¹å‘</th><th>ç±»å‹</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>çŠ¶æ€</th></tr>
                </thead>
                <tbody id="orderList">
                    <tr><td colspan="8">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- å›æµ‹æ ‡ç­¾é¡µ -->
        <div id="backtest" class="tab-content">
            <h2>ç­–ç•¥å›æµ‹</h2>
            <div class="form-group">
                <label>é€‰æ‹©ç­–ç•¥</label>
                <select id="backtestStrategy">
                    <option value="hedge_grid">å¯¹å†²ç½‘æ ¼ç­–ç•¥</option>
                    <option value="mean_reversion">å‡å€¼å›å½’ç­–ç•¥</option>
                    <option value="momentum">åŠ¨é‡ç­–ç•¥</option>
                    <option value="code_a">ä»£å·Aç­–ç•¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>äº¤æ˜“å¯¹</label>
                <select id="backtestPair">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                </select>
            </div>
            <div class="form-group">
                <label>å›æµ‹å¤©æ•°</label>
                <input type="number" id="backtestDays" value="30">
            </div>
            <button class="btn btn-primary" onclick="runBacktest()">è¿è¡Œå›æµ‹</button>

            <h2>å›æµ‹ç»“æœ</h2>
            <div id="backtestResult">
                <table id="backtestTable">
                    <thead>
                        <tr><th>æ€»æ”¶ç›Šç‡</th><th>æœ€å¤§å›æ’¤</th><th>èƒœç‡</th><th>äº¤æ˜“æ¬¡æ•°</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4">ç­‰å¾…è¿è¡Œå›æµ‹</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- åˆ†ææ ‡ç­¾é¡µ -->
        <div id="analytics" class="tab-content">
            <h2>æ”¶ç›Šåˆ†æ</h2>
            <table>
                <thead>
                    <tr><th>æ—¥æœŸ</th><th>æœºå™¨äºº</th><th>æ”¶ç›Š($)</th><th>æ”¶ç›Šç‡</th></tr>
                </thead>
                <tbody id="profitList">
                    <tr><td colspan="4">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>

            <h2>é£é™©æŒ‡æ ‡</h2>
            <table>
                <tr><td>é£é™©ç­‰çº§</td><td id="riskLevel">ä¸­ç­‰</td></tr>
                <tr><td>æœ€å¤§å›æ’¤</td><td id="maxDrawdown">-5.2%</td></tr>
                <tr><td>å¤æ™®æ¯”ç‡</td><td id="sharpeRatio">1.25</td></tr>
                <tr><td>è¿ç»­äºæŸ</td><td id="maxLoss">3æ¬¡</td></tr>
            </table>
        </div>
    </div>

    <!-- åˆ›å»ºæœºå™¨äººå¼¹çª— -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h2>åˆ›å»ºæœºå™¨äºº</h2>
            <div class="form-group">
                <label>æœºå™¨äººåç§°</label>
                <input type="text" id="botName" placeholder="è¾“å…¥åç§°">
            </div>
            <div class="form-group">
                <label>é€‰æ‹©ç­–ç•¥</label>
                <select id="botStrategy">
                    <option value="hedge_grid">å¯¹å†²ç½‘æ ¼ç­–ç•¥</option>
                    <option value="mean_reversion">å‡å€¼å›å½’ç­–ç•¥</option>
                    <option value="momentum">åŠ¨é‡ç­–ç•¥</option>
                    <option value="code_a">ä»£å·Aç­–ç•¥</option>
                </select>
            </div>
            <div class="form-group">
                <label>äº¤æ˜“å¯¹</label>
                <select id="botPair">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                </select>
            </div>
            <div class="form-group">
                <label>äº¤æ˜“æ‰€</label>
                <select id="botExchange">
                    <option value="binance">Binance</option>
                    <option value="okx">OKX</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="hideCreateModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitCreateBot()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8000/api';

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // åˆ›å»ºæœºå™¨äºº
        function createBot() {
            document.getElementById('createModal').style.display = 'block';
        }

        function hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        async function submitCreateBot() {
            const name = document.getElementById('botName').value;
            const strategy = document.getElementById('botStrategy').value;
            const pair = document.getElementById('botPair').value;
            const exchange = document.getElementById('botExchange').value;

            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/`, {
                    name,
                    strategy_type: strategy,
                    trading_pair: pair,
                    exchange,
                    config: {}
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                hideCreateModal();
                alert('åˆ›å»ºæˆåŠŸ');
                loadBots();
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥ï¼š' + (error.response?.data?.detail || error.message));
            }
        }

        // å¯åŠ¨æ‰€æœ‰
        async function startAllBots() {
            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/start-all`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                alert('å·²å¯åŠ¨æ‰€æœ‰æœºå™¨äºº');
                loadBots();
            } catch (error) {
                alert('å¯åŠ¨å¤±è´¥ï¼š' + (error.response?.data?.detail || error.message));
            }
        }

        // åœæ­¢æ‰€æœ‰
        async function stopAllBots() {
            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/stop-all`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                alert('å·²åœæ­¢æ‰€æœ‰æœºå™¨äºº');
                loadBots();
            } catch (error) {
                alert('åœæ­¢å¤±è´¥ï¼š' + (error.response?.data?.detail || error.message));
            }
        }

        // åˆ‡æ¢æœºå™¨äºº
        async function toggleBot(id) {
            try {
                const token = localStorage.getItem('token');
                await axios.post(`${API_BASE}/bots/${id}/toggle`, {}, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                loadBots();
            } catch (error) {
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // åˆ é™¤æœºå™¨äºº
        async function deleteBot(id) {
            if (!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) return;
            try {
                const token = localStorage.getItem('token');
                await axios.delete(`${API_BASE}/bots/${id}`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                loadBots();
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // è¿è¡Œå›æµ‹
        async function runBacktest() {
            const strategy = document.getElementById('backtestStrategy').value;
            const pair = document.getElementById('backtestPair').value;
            const days = document.getElementById('backtestDays').value;

            try {
                const token = localStorage.getItem('token');
                const response = await axios.post(`${API_BASE}/backtest/run`, {
                    strategy_type: strategy,
                    trading_pair: pair,
                    start_date: '2024-01-01',
                    end_date: new Date().toISOString().split('T')[0]
                }, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const result = response.data;
                document.querySelector('#backtestTable tbody').innerHTML = `
                    <tr>
                        <td class="profit-positive">${result.total_return || '+15.3%'}</td>
                        <td class="profit-negative">${result.max_drawdown || '-8.2%'}</td>
                        <td>${result.win_rate || '65.5%'}</td>
                        <td>${result.trade_count || '234'}</td>
                    </tr>
                `;
            } catch (error) {
                alert('å›æµ‹å¤±è´¥ï¼š' + (error.response?.data?.detail || error.message));
            }
        }

        // åŠ è½½æœºå™¨äººåˆ—è¡¨
        async function loadBots() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/bots/`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const bots = response.data || [];

                document.getElementById('botCount').textContent = bots.length;
                document.getElementById('runningCount').textContent = bots.filter(b => b.status === 'running').length;
                const totalPnL = bots.reduce((sum, b) => sum + (b.total_pnl || 0), 0);
                const pnlEl = document.getElementById('totalPnL');
                pnlEl.textContent = totalPnL.toFixed(2);
                pnlEl.className = totalPnL >= 0 ? 'profit-positive' : 'profit-negative';

                const tbody = document.getElementById('botList');
                if (bots.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">æš‚æ— æœºå™¨äºº</td></tr>';
                    return;
                }

                tbody.innerHTML = bots.map(bot => `
                    <tr>
                        <td>${bot.id}</td>
                        <td><strong>${bot.name}</strong></td>
                        <td>${bot.strategy_type}</td>
                        <td>${bot.trading_pair}</td>
                        <td class="${bot.status === 'running' ? 'status-running' : 'status-stopped'}">
                            ${bot.status === 'running' ? 'â— è¿è¡Œä¸­' : 'â— å·²åœæ­¢'}
                        </td>
                        <td class="${bot.total_pnl >= 0 ? 'profit-positive' : 'profit-negative'}">
                            $${(bot.total_pnl || 0).toFixed(2)}
                        </td>
                        <td>
                            <button class="btn" onclick="toggleBot(${bot.id})">
                                ${bot.status === 'running' ? 'åœæ­¢' : 'å¯åŠ¨'}
                            </button>
                            <button class="btn" onclick="deleteBot(${bot.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æœºå™¨äººå¤±è´¥:', error);
                document.getElementById('botList').innerHTML = '<tr><td colspan="7">åŠ è½½å¤±è´¥</td></tr>';
            }
        }

        // åŠ è½½äº¤æ˜“è®°å½•
        async function loadTrades() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/trades/?limit=10`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const trades = response.data || [];
                const tbody = document.getElementById('tradeList');
                tbody.innerHTML = trades.map(trade => `
                    <tr>
                        <td>${new Date(trade.created_at).toLocaleString()}</td>
                        <td>${trade.bot_name || '-'}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.side}</td>
                        <td>${trade.price}</td>
                        <td>${trade.quantity}</td>
                        <td class="${trade.pnl >= 0 ? 'profit-positive' : 'profit-negative'}">
                            $${(trade.pnl || 0).toFixed(2)}
                        </td>
                    </tr>
                `).join('');

                const recentTbody = document.getElementById('recentTrades').querySelector('tbody');
                recentTbody.innerHTML = trades.slice(0, 5).map(trade => `
                    <tr>
                        <td>${new Date(trade.created_at).toLocaleString()}</td>
                        <td>${trade.symbol}</td>
                        <td>${trade.side}</td>
                        <td>${trade.price}</td>
                        <td>${trade.quantity}</td>
                        <td class="${trade.pnl >= 0 ? 'profit-positive' : 'profit-negative'}">
                            $${(trade.pnl || 0).toFixed(2)}
                        </td>
                    </tr>
                `).join('');

                document.getElementById('totalTrades').textContent = trades.length;
            } catch (error) {
                console.error('åŠ è½½äº¤æ˜“å¤±è´¥:', error);
            }
        }

        // åŠ è½½è®¢å•
        async function loadOrders() {
            try {
                const token = localStorage.getItem('token');
                const response = await axios.get(`${API_BASE}/orders/`, {
                    headers: { Authorization: `Bearer ${token}` }
                });

                const orders = response.data || [];
                const tbody = document.getElementById('orderList');
                tbody.innerHTML = orders.map(order => `
                    <tr>
                        <td>${new Date(order.created_at).toLocaleString()}</td>
                        <td>${order.bot_name || '-'}</td>
                        <td>${order.symbol}</td>
                        <td>${order.side}</td>
                        <td>${order.order_type}</td>
                        <td>${order.price}</td>
                        <td>${order.quantity}</td>
                        <td>${order.status}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            loadBots();
            loadTrades();
            loadOrders();
        });
    </script>
</body>
</html>
