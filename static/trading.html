<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时交易 - 加密货币交易系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=stylesheet" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .price-up {
            color: #10b981;
            animation: flashGreen 0.3s ease;
        }

        .price-down {
            color: #ef4444;
            animation: flashRed 0.3s ease;
        }

        @keyframes flashGreen {
            0% { background-color: rgba(16, 185, 129, 0.2); }
            100% { background-color: transparent; }
        }

        @keyframes flashRed {
            0% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: transparent; }
        }

        .depth-bar {
            transition: width 0.3s ease;
        }

        .trade-item {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chart-container {
            height: 400px;
        }

        .loading-spinner {
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-white">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <button onclick="goBack()" class="mr-4 p-2 hover:bg-gray-700 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold">实时交易</h1>
                </div>
                <div class="flex items-center gap-4">
                    <select id="selectPair" onchange="changePair()" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm">
                        <option value="BTC/USDT">BTC/USDT</option>
                        <option value="ETH/USDT">ETH/USDT</option>
                        <option value="BNB/USDT">BNB/USDT</option>
                    </select>
                    <div id="connectionStatus" class="flex items-center text-sm">
                        <span class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></span>
                        <span>连接中...</span>
                    </div>
                    <div id="dataSource" class="hidden flex items-center text-xs px-3 py-1 rounded-full" title="数据来源">
                        <span></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Price Display -->
    <div class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm" id="currentPair">BTC/USDT</p>
                    <p class="text-4xl font-bold mt-1" id="currentPrice">$0.00</p>
                    <p class="text-sm mt-2" id="priceChange">+0.00%</p>
                </div>
                <div class="grid grid-cols-4 gap-6 text-right">
                    <div>
                        <p class="text-gray-400 text-xs">24h最高</p>
                        <p class="text-lg font-semibold" id="high24h">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">24h最低</p>
                        <p class="text-lg font-semibold" id="low24h">$0.00</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">24h成交量</p>
                        <p class="text-lg font-semibold" id="volume24h">0</p>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs">24h成交额</p>
                        <p class="text-lg font-semibold" id="amount24h">$0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- K线图 -->
            <div class="lg:col-span-3">
                <div class="bg-gray-800 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">K线图</h2>
                        <div class="flex gap-2">
                            <button onclick="changeTimeframe('1m')" class="timeframe-btn px-3 py-1 text-sm bg-gray-700 rounded-lg hover:bg-gray-600">1m</button>
                            <button onclick="changeTimeframe('5m')" class="timeframe-btn px-3 py-1 text-sm bg-gray-700 rounded-lg hover:bg-gray-600">5m</button>
                            <button onclick="changeTimeframe('15m')" class="timeframe-btn px-3 py-1 text-sm bg-indigo-600 rounded-lg">15m</button>
                            <button onclick="changeTimeframe('1h')" class="timeframe-btn px-3 py-1 text-sm bg-gray-700 rounded-lg hover:bg-gray-600">1h</button>
                            <button onclick="changeTimeframe('4h')" class="timeframe-btn px-3 py-1 text-sm bg-gray-700 rounded-lg hover:bg-gray-600">4h</button>
                            <button onclick="changeTimeframe('1d')" class="timeframe-btn px-3 py-1 text-sm bg-gray-700 rounded-lg hover:bg-gray-600">1d</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="candlestickChart"></canvas>
                    </div>
                </div>

                <!-- 深度图 -->
                <div class="bg-gray-800 rounded-xl p-4">
                    <h2 class="text-lg font-semibold mb-4">深度图</h2>
                    <div class="chart-container">
                        <canvas id="depthChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 订单簿和最近交易 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 订单簿 -->
                <div class="bg-gray-800 rounded-xl p-4">
                    <h2 class="text-lg font-semibold mb-4">订单簿</h2>

                    <!-- 卖单 -->
                    <div class="mb-4">
                        <p class="text-xs text-gray-400 mb-2">卖单</p>
                        <div id="orderBookAsks" class="space-y-1 text-xs">
                            <!-- Asks will be rendered here -->
                        </div>
                    </div>

                    <!-- 当前价格 -->
                    <div class="py-3 border-t border-b border-gray-700 text-center mb-4">
                        <p class="text-2xl font-bold" id="midPrice">$0.00</p>
                    </div>

                    <!-- 买单 -->
                    <div>
                        <p class="text-xs text-gray-400 mb-2">买单</p>
                        <div id="orderBookBids" class="space-y-1 text-xs">
                            <!-- Bids will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- 最近交易 -->
                <div class="bg-gray-800 rounded-xl p-4">
                    <h2 class="text-lg font-semibold mb-4">最近交易</h2>
                    <div class="flex text-xs text-gray-400 mb-2">
                        <div class="flex-1">价格</div>
                        <div class="flex-1">数量</div>
                        <div class="flex-1 text-right">时间</div>
                    </div>
                    <div id="recentTrades" class="space-y-1 text-xs max-h-96 overflow-y-auto">
                        <!-- Recent trades will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('token');
        let ws = null;
        let candlestickChart = null;
        let depthChart = null;
        let currentPair = 'BTC/USDT';
        let currentTimeframe = '15m';
        let previousPrice = 0;

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                window.location.href = '/static/auth.html';
                return;
            }

            initCharts();
            connectWebSocket();
            loadInitialData();
        });

        // 初始化图表
        function initCharts() {
            // K线图
            const candleCtx = document.getElementById('candlestickChart').getContext('2d');

            // 模拟K线数据
            const candleData = generateCandlestickData(50);

            candlestickChart = new Chart(candleCtx, {
                type: 'line',
                data: {
                    labels: candleData.labels,
                    datasets: [{
                        label: '价格',
                        data: candleData.prices,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        }
                    }
                }
            });

            // 深度图
            const depthCtx = document.getElementById('depthChart').getContext('2d');
            const depthData = generateDepthData();

            depthChart = new Chart(depthCtx, {
                type: 'bar',
                data: {
                    labels: depthData.labels,
                    datasets: [
                        {
                            label: '买单',
                            data: depthData.bids,
                            backgroundColor: 'rgba(16, 185, 129, 0.5)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: '卖单',
                            data: depthData.asks,
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#9ca3af'
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            stacked: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        }
                    }
                }
            });
        }

        // 生成模拟K线数据
        function generateCandlestickData(count) {
            const labels = [];
            const prices = [];
            let price = 50000;

            for (let i = 0; i < count; i++) {
                labels.push(`${i}:00`);
                price += (Math.random() - 0.5) * 500;
                prices.push(price);
            }

            return { labels, prices };
        }

        // 生成模拟深度数据
        function generateDepthData() {
            const labels = [];
            const bids = [];
            const asks = [];
            let price = 50000;

            for (let i = 0; i < 20; i++) {
                labels.push(price.toFixed(2));
                bids.push(Math.random() * 10);
                asks.push(Math.random() * 10);
                price += 100;
            }

            return { labels, bids, asks };
        }

        // 测试交易所连接
        async function testExchangeConnection() {
            try {
                const response = await axios.get(`${API_BASE}/exchange/test-connection`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.data.success && response.data.data.success) {
                    updateConnectionStatus('connected', response.data.data.exchange);
                    return true;
                } else {
                    updateConnectionStatus('failed', response.data.data.error);
                    return false;
                }
            } catch (error) {
                console.error('Test connection error:', error);
                updateConnectionStatus('failed', '连接失败');
                return false;
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connectionStatus');
            const dot = statusDiv.querySelector('span:first-child');
            const text = statusDiv.querySelector('span:last-child');

            if (status === 'connected') {
                dot.className = 'w-2 h-2 rounded-full bg-green-500 mr-2';
                text.textContent = `已连接: ${message}`;
            } else if (status === 'failed') {
                dot.className = 'w-2 h-2 rounded-full bg-red-500 mr-2';
                text.textContent = `连接失败: ${message}`;
            }
        }

        // 显示数据来源
        function showDataSource(source, warning = null) {
            const sourceDiv = document.getElementById('dataSource');
            sourceDiv.classList.remove('hidden');

            if (source === 'real') {
                sourceDiv.className = 'flex items-center text-xs px-3 py-1 rounded-full bg-green-900/30 border border-green-500/30';
                sourceDiv.querySelector('span').textContent = '真实数据';
                sourceDiv.title = '使用真实交易所数据';
            } else {
                sourceDiv.className = 'flex items-center text-xs px-3 py-1 rounded-full bg-yellow-900/30 border border-yellow-500/30';
                sourceDiv.querySelector('span').textContent = '模拟数据';
                sourceDiv.title = warning || '当前使用模拟数据';
            }
        }

        // 加载初始数据
        async function loadInitialData() {
            try {
                // 先测试交易所连接
                await testExchangeConnection();

                // 加载订单簿
                const response = await axios.get(`${API_BASE}/exchange/orderbook?symbol=${currentPair}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.data) {
                    // 显示数据来源
                    const source = response.data.source || 'unknown';
                    showDataSource(source, response.data.warning);

                    renderOrderBook(response.data);
                }
            } catch (error) {
                console.error('Load initial data error:', error);
                // 使用模拟数据
                showDataSource('simulated', 'API调用失败，使用模拟数据');
                renderOrderBook(generateMockOrderBook());
            }
        }

        // 生成模拟订单簿
        function generateMockOrderBook() {
            const bids = [];
            const asks = [];
            let price = 50000;

            for (let i = 0; i < 10; i++) {
                asks.unshift({
                    price: (price + (i + 1) * 10).toFixed(2),
                    amount: (Math.random() * 5).toFixed(4)
                });
                bids.push({
                    price: (price - i * 10).toFixed(2),
                    amount: (Math.random() * 5).toFixed(4)
                });
            }

            return { bids, asks, mid: price.toFixed(2) };
        }

        // 渲染订单簿
        function renderOrderBook(data) {
            // 更新中间价
            document.getElementById('midPrice').textContent = '$' + data.mid;

            // 渲染卖单
            const asksContainer = document.getElementById('orderBookAsks');
            const maxAskAmount = Math.max(...data.asks.map(a => parseFloat(a.amount)));

            asksContainer.innerHTML = data.asks.slice(0, 8).map(ask => {
                const percentage = (parseFloat(ask.amount) / maxAskAmount) * 100;
                return `
                    <div class="flex items-center text-xs relative">
                        <div class="depth-bar absolute inset-0 bg-red-500/20" style="width: ${percentage}%"></div>
                        <div class="flex-1 relative z-10 text-red-400">${ask.price}</div>
                        <div class="flex-1 relative z-10 text-center">${ask.amount}</div>
                        <div class="flex-1 relative z-10 text-right text-gray-400">${(parseFloat(ask.price) * parseFloat(ask.amount)).toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            // 渲染买单
            const bidsContainer = document.getElementById('orderBookBids');
            const maxBidAmount = Math.max(...data.bids.map(b => parseFloat(b.amount)));

            bidsContainer.innerHTML = data.bids.slice(0, 8).map(bid => {
                const percentage = (parseFloat(bid.amount) / maxBidAmount) * 100;
                return `
                    <div class="flex items-center text-xs relative">
                        <div class="depth-bar absolute inset-0 bg-green-500/20" style="width: ${percentage}%"></div>
                        <div class="flex-1 relative z-10 text-green-400">${bid.price}</div>
                        <div class="flex-1 relative z-10 text-center">${bid.amount}</div>
                        <div class="flex-1 relative z-10 text-right text-gray-400">${(parseFloat(bid.price) * parseFloat(bid.amount)).toFixed(0)}</div>
                    </div>
                `;
            }).reverse().join('');
        }

        // WebSocket连接
        function connectWebSocket() {
            if (ws) {
                ws.close();
            }

            ws = new WebSocket(`ws://localhost:8000/ws?token=${authToken}`);

            ws.onopen = () => {
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.type === 'market_data') {
                    updatePrice(data.data.price);
                } else if (data.type === 'order_book') {
                    renderOrderBook(data.data);
                } else if (data.type === 'trade') {
                    addRecentTrade(data.data);
                }
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                console.log('WebSocket closed, reconnecting...');
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>
                    <span class="text-green-500">已连接</span>
                `;
            } else {
                statusElement.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>
                    <span class="text-red-500">连接中...</span>
                `;
            }
        }

        // 更新价格
        function updatePrice(price) {
            const priceElement = document.getElementById('currentPrice');
            const changeElement = document.getElementById('priceChange');
            const midPriceElement = document.getElementById('midPrice');

            priceElement.textContent = '$' + price.toFixed(2);
            midPriceElement.textContent = '$' + price.toFixed(2);

            if (previousPrice > 0) {
                const change = ((price - previousPrice) / previousPrice) * 100;
                changeElement.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                changeElement.className = 'text-sm mt-2 ' + (change >= 0 ? 'text-green-500' : 'text-red-500');

                // 价格动画
                if (price > previousPrice) {
                    priceElement.classList.add('price-up');
                    setTimeout(() => priceElement.classList.remove('price-up'), 300);
                } else if (price < previousPrice) {
                    priceElement.classList.add('price-down');
                    setTimeout(() => priceElement.classList.remove('price-down'), 300);
                }
            }

            previousPrice = price;
        }

        // 添加最近交易
        function addRecentTrade(trade) {
            const tradesContainer = document.getElementById('recentTrades');
            const tradeElement = document.createElement('div');
            tradeElement.className = 'trade-item flex items-center';
            tradeElement.innerHTML = `
                <div class="flex-1 ${trade.side === 'buy' ? 'text-green-400' : 'text-red-400'}">${trade.price.toFixed(2)}</div>
                <div class="flex-1 text-center">${trade.amount.toFixed(4)}</div>
                <div class="flex-1 text-right text-gray-400">${new Date().toLocaleTimeString()}</div>
            `;

            tradesContainer.insertBefore(tradeElement, tradesContainer.firstChild);

            // 保持最多20条记录
            while (tradesContainer.children.length > 20) {
                tradesContainer.removeChild(tradesContainer.lastChild);
            }
        }

        // 改变交易对
        function changePair() {
            currentPair = document.getElementById('selectPair').value;
            document.getElementById('currentPair').textContent = currentPair;
            loadInitialData();
        }

        // 改变时间周期
        function changeTimeframe(timeframe) {
            currentTimeframe = timeframe;

            // 更新按钮样式
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.classList.remove('bg-gray-700');
            event.target.classList.add('bg-indigo-600');

            // 重新加载K线数据
            // 实际应用中应该调用API获取新的K线数据
        }

        // 返回
        function goBack() {
            window.location.href = '/static/main-dashboard.html';
        }
    </script>
</body>
</html>
