<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤æ˜“ç³»ç»Ÿ - æç®€ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font: 12px/1.5 Arial, sans-serif;
            background: #fff;
            color: #333;
            padding: 10px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* é¡¶éƒ¨æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 2px solid #000;
            margin-bottom: 10px;
        }
        .header h1 { font-size: 18px; font-weight: bold; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-info span { font-size: 12px; }
        .btn-small {
            padding: 3px 8px;
            font-size: 11px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
        }
        .btn-small:hover { background: #000; color: #fff; }
        
        /* æ ‡ç­¾å¯¼èˆª */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }
        .tab-btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-bottom: none;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .tab-btn:hover { background: #e0e0e0; }
        .tab-btn.active { background: #000; color: #fff; }
        
        /* å†…å®¹åŒº */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
            font-size: 12px;
        }
        th { background: #f5f5f5; font-weight: bold; }
        tr:hover { background: #f9f9f9; }
        
        /* æŒ‰é’® */
        .btn {
            padding: 4px 10px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            font-size: 12px;
            margin-right: 3px;
        }
        .btn:hover { background: #000; color: #fff; }
        .btn-success { border-color: #28a745; color: #28a745; }
        .btn-success:hover { background: #28a745; color: #fff; }
        .btn-danger { border-color: #dc3545; color: #dc3545; }
        .btn-danger:hover { background: #dc3545; color: #fff; }
        .btn-primary { background: #000; color: #fff; }
        
        /* è¡¨å• */
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 3px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            font-size: 12px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }
        .stat-box {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .stat-box strong { display: block; font-size: 20px; }
        .stat-box span { font-size: 11px; color: #666; }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active { display: block; }
        .modal-content {
            background: #fff;
            padding: 15px;
            margin: 30px auto;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid #000;
        }
        .modal-buttons { margin-top: 15px; text-align: right; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .status-running { color: #28a745; font-weight: bold; }
        .status-stopped { color: #dc3545; font-weight: bold; }
        .profit-pos { color: #28a745; font-weight: bold; }
        .profit-neg { color: #dc3545; font-weight: bold; }
        
        /* åˆ†é¡µ */
        .pagination { display: flex; gap: 5px; align-items: center; }
        .pagination button { padding: 3px 8px; margin: 0; }
        
        /* å·¥å…·æ  */
        .toolbar { margin-bottom: 10px; padding: 10px; background: #f9f9f9; }
        .toolbar-left { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
        .toolbar-right { display: flex; gap: 5px; align-items: center; }
        
        /* ç™»å½•æ¡† */
        .login-box {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border: 2px solid #000;
        }
        .login-box h2 { text-align: center; margin-bottom: 20px; }
        .login-box button { width: 100%; margin-top: 10px; }
        
        /* æ—¥å¿— */
        .log-container {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .tabs { max-height: 120px; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="loginSection" class="login-box">
            <h2>ç³»ç»Ÿç™»å½•</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
            <p style="margin-top: 10px; color: #666; font-size: 11px;">é»˜è®¤è´¦å·: admin / admin123</p>
        </div>
        
        <!-- ä¸»ç•Œé¢ -->
        <div id="mainSection" style="display: none;">
            <!-- é¡¶éƒ¨æ  -->
            <div class="header">
                <h1>åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ</h1>
                <div class="user-info">
                    <span id="currentUsername">-</span>
                    <button class="btn-small" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
            
            <!-- æ ‡ç­¾å¯¼èˆª -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('dashboard')">ä»ªè¡¨ç›˜</button>
                <button class="tab-btn" onclick="showTab('bots')">æœºå™¨äººç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('trades')">äº¤æ˜“è®°å½•</button>
                <button class="tab-btn" onclick="showTab('orders')">è®¢å•ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('exchanges')">äº¤æ˜“æ‰€ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('risk')">é£é™©ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('backtest')">å›æµ‹</button>
                <button class="tab-btn" onclick="showTab('strategies')">é«˜çº§ç­–ç•¥</button>
                <button class="tab-btn" onclick="showTab('analytics')">æ•°æ®åˆ†æ</button>
                <button class="tab-btn" onclick="showTab('users')">ç”¨æˆ·ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('audit')">å®¡è®¡æ—¥å¿—</button>
                <button class="tab-btn" onclick="showTab('performance')">æ€§èƒ½ç›‘æ§</button>
                <button class="tab-btn" onclick="showTab('database')">æ•°æ®åº“ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('logs')">æ—¥å¿—ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('notifications')">é€šçŸ¥ç®¡ç†</button>
                <button class="tab-btn" onclick="showTab('settings')">ç³»ç»Ÿè®¾ç½®</button>
            </div>
            
            <!-- ä»ªè¡¨ç›˜ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats" id="dashboardStats"></div>
                <h3>æœ€è¿‘äº¤æ˜“</h3>
                <table id="recentTrades">
                    <thead><tr><th>æ—¶é—´</th><th>æœºå™¨äºº</th><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>åˆ©æ¶¦</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- æœºå™¨äººç®¡ç† -->
            <div id="bots" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showCreateBotModal()">åˆ›å»ºæœºå™¨äºº</button>
                        <button class="btn" onclick="refreshBots()">åˆ·æ–°</button>
                    </div>
                </div>
                <table id="botsTable">
                    <thead>
                        <tr><th>ID</th><th>åç§°</th><th>äº¤æ˜“æ‰€</th><th>äº¤æ˜“å¯¹</th><th>ç­–ç•¥</th><th>çŠ¶æ€</th><th>åˆ©æ¶¦</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- äº¤æ˜“è®°å½• -->
            <div id="trades" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshTrades()">åˆ·æ–°</button>
                        <button class="btn" onclick="exportTrades()">å¯¼å‡ºCSV</button>
                        <select id="tradeBotFilter" onchange="filterTrades()"><option value="">å…¨éƒ¨æœºå™¨äºº</option></select>
                    </div>
                    <div class="toolbar-right">
                        <input type="text" placeholder="æœç´¢..." style="padding: 4px; border: 1px solid #ccc;">
                    </div>
                </div>
                <table id="tradesTable">
                    <thead>
                        <tr><th>æ—¶é—´</th><th>æœºå™¨äºº</th><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>åˆ©æ¶¦</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- è®¢å•ç®¡ç† -->
            <div id="orders" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshOrders()">åˆ·æ–°</button>
                        <button class="btn" onclick="cancelAllOrders()">å–æ¶ˆå…¨éƒ¨è®¢å•</button>
                        <select id="orderStatusFilter" onchange="refreshOrders()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="open">æœªæˆäº¤</option>
                            <option value="closed">å·²æˆäº¤</option>
                            <option value="canceled">å·²å–æ¶ˆ</option>
                        </select>
                        <select id="orderBotFilter" onchange="refreshOrders()"><option value="">å…¨éƒ¨æœºå™¨äºº</option></select>
                    </div>
                </div>
                <table id="ordersTable">
                    <thead>
                        <tr><th>ID</th><th>æœºå™¨äºº</th><th>äº¤æ˜“å¯¹</th><th>ç±»å‹</th><th>æ–¹å‘</th><th>ä»·æ ¼</th><th>æ•°é‡</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- äº¤æ˜“æ‰€ç®¡ç† -->
            <div id="exchanges" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showAddExchangeModal()">æ·»åŠ äº¤æ˜“æ‰€</button>
                        <button class="btn" onclick="testAllExchanges()">æµ‹è¯•è¿æ¥</button>
                    </div>
                </div>
                <table id="exchangesTable">
                    <thead>
                        <tr><th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>APIå¯†é’¥</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- é£é™©ç®¡ç† -->
            <div id="risk" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshRisk()">åˆ·æ–°</button>
                        <button class="btn btn-danger" onclick="closeAllPositions()">å¹³ä»“æ‰€æœ‰</button>
                    </div>
                </div>
                <div class="stats" id="riskStats"></div>
                <table id="riskTable">
                    <thead>
                        <tr><th>æœºå™¨äºº</th><th>æŒä»“ä»·å€¼</th><th>æœªå®ç°ç›ˆäº</th><th>é£é™©ç­‰çº§</th><th>ä»“ä½é™åˆ¶</th><th>æ­¢æŸè®¾ç½®</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- å›æµ‹ -->
            <div id="backtest" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showBacktestModal()">æ–°å»ºå›æµ‹</button>
                        <button class="btn" onclick="refreshBacktests()">åˆ·æ–°</button>
                    </div>
                </div>
                <table id="backtestsTable">
                    <thead>
                        <tr><th>ID</th><th>ç­–ç•¥</th><th>äº¤æ˜“å¯¹</th><th>æ—¶é—´èŒƒå›´</th><th>æ€»åˆ©æ¶¦</th><th>èƒœç‡</th><th>æœ€å¤§å›æ’¤</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- é«˜çº§ç­–ç•¥ -->
            <div id="strategies" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showCreateStrategyModal()">åˆ›å»ºç­–ç•¥</button>
                    </div>
                </div>
                <table id="strategiesTable">
                    <thead>
                        <tr><th>ID</th><th>åç§°</th><th>ç±»å‹</th><th>å‚æ•°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- æ•°æ®åˆ†æ -->
            <div id="analytics" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshAnalytics()">åˆ·æ–°</button>
                        <select id="analyticsType" onchange="refreshAnalytics()">
                            <option value="overview">æ¦‚è§ˆ</option>
                            <option value="performance">æ€§èƒ½åˆ†æ</option>
                            <option value="trend">è¶‹åŠ¿åˆ†æ</option>
                        </select>
                    </div>
                </div>
                <div id="analyticsContent"></div>
            </div>
            
            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="users" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showCreateUserModal()">åˆ›å»ºç”¨æˆ·</button>
                        <button class="btn" onclick="refreshUsers()">åˆ·æ–°</button>
                    </div>
                </div>
                <table id="usersTable">
                    <thead>
                        <tr><th>ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- å®¡è®¡æ—¥å¿— -->
            <div id="audit" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshAuditLogs()">åˆ·æ–°</button>
                        <select id="auditUserFilter" onchange="filterAuditLogs()"><option value="">å…¨éƒ¨ç”¨æˆ·</option></select>
                        <select id="auditActionFilter" onchange="filterAuditLogs()">
                            <option value="">å…¨éƒ¨æ“ä½œ</option>
                            <option value="login">ç™»å½•</option>
                            <option value="bot_operation">æœºå™¨äººæ“ä½œ</option>
                            <option value="order_operation">è®¢å•æ“ä½œ</option>
                            <option value="config_change">é…ç½®å˜æ›´</option>
                        </select>
                        <input type="date" id="auditDateFilter" onchange="filterAuditLogs()">
                        <button class="btn" onclick="exportAuditLogs()">å¯¼å‡ºCSV</button>
                        <button class="btn" onclick="exportAuditLogsJSON()">å¯¼å‡ºJSON</button>
                    </div>
                </div>
                <table id="auditLogsTable">
                    <thead>
                        <tr><th>æ—¶é—´</th><th>ç”¨æˆ·</th><th>æ“ä½œ</th><th>èµ„æº</th><th>IPåœ°å€</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- æ€§èƒ½ç›‘æ§ -->
            <div id="performance" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshPerformance()">åˆ·æ–°</button>
                    </div>
                </div>
                <div class="stats" id="performanceStats"></div>
                <table id="performanceTable">
                    <thead>
                        <tr><th>æŒ‡æ ‡</th><th>å½“å‰å€¼</th><th>é˜ˆå€¼</th><th>çŠ¶æ€</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- æ•°æ®åº“ç®¡ç† -->
            <div id="database" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-success" onclick="backupDatabase()">å¤‡ä»½æ•°æ®åº“</button>
                        <button class="btn btn-danger" onclick="optimizeDatabase()">ä¼˜åŒ–æ•°æ®åº“</button>
                        <button class="btn" onclick="analyzeDatabase()">åˆ†ææ•°æ®åº“</button>
                    </div>
                </div>
                <div id="dbStatus"></div>
                <table id="dbBackupsTable">
                    <thead>
                        <tr><th>æ–‡ä»¶å</th><th>å¤§å°</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- æ—¥å¿—ç®¡ç† -->
            <div id="logs" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn" onclick="refreshLogs()">åˆ·æ–°</button>
                        <select id="logLevel" onchange="filterLogs()">
                            <option value="">å…¨éƒ¨çº§åˆ«</option>
                            <option value="ERROR">ERROR</option>
                            <option value="WARNING">WARNING</option>
                            <option value="INFO">INFO</option>
                            <option value="DEBUG">DEBUG</option>
                        </select>
                        <select id="logModule" onchange="filterLogs()">
                            <option value="">å…¨éƒ¨æ¨¡å—</option>
                            <option value="bot">æœºå™¨äºº</option>
                            <option value="trading">äº¤æ˜“</option>
                            <option value="risk">é£é™©</option>
                            <option value="system">ç³»ç»Ÿ</option>
                        </select>
                        <input type="text" id="logKeyword" placeholder="æœç´¢å…³é”®è¯..." onchange="filterLogs()" style="padding:4px;border:1px solid #ccc;">
                        <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                        <button class="btn" onclick="archiveLogs()">å½’æ¡£æ—¥å¿—</button>
                        <button class="btn" onclick="downloadLogs()">ä¸‹è½½æ—¥å¿—</button>
                    </div>
                </div>
                <div class="log-container" id="logsContainer"></div>
            </div>
            
            <!-- é€šçŸ¥ç®¡ç† -->
            <div id="notifications" class="tab-content">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showAddNotificationModal()">æ·»åŠ é€šçŸ¥é…ç½®</button>
                        <button class="btn" onclick="testNotification()">æµ‹è¯•é€šçŸ¥</button>
                        <button class="btn" onclick="refreshNotifications()">åˆ·æ–°</button>
                    </div>
                </div>
                <h3>é€šçŸ¥æ¸ é“é…ç½®</h3>
                <table id="notificationsTable">
                    <thead>
                        <tr><th>æ¸ é“</th><th>é…ç½®</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <h3>é€šçŸ¥å†å²</h3>
                <div style="max-height:300px;overflow-y:auto;border:1px solid #ddd;padding:10px;">
                    <table id="notificationHistoryTable">
                        <thead><tr><th>æ—¶é—´</th><th>æ¸ é“</th><th>ç±»å‹</th><th>å†…å®¹</th><th>çŠ¶æ€</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div id="settings" class="tab-content">
                <h3>ç³»ç»Ÿé…ç½®</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç³»ç»Ÿåç§°</label>
                        <input type="text" id="systemName" placeholder="åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ">
                    </div>
                    <div class="form-group">
                        <label>æ—¶åŒº</label>
                        <select id="timezone">
                            <option value="Asia/Shanghai">Asia/Shanghai</option>
                            <option value="UTC">UTC</option>
                            <option value="America/New_York">America/New_York</option>
                        </select>
                    </div>
                </div>
                
                <h3>äº¤æ˜“æ‰€é»˜è®¤é…ç½®</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>é»˜è®¤äº¤æ˜“æ‰€</label>
                        <select id="defaultExchange">
                            <option value="binance">Binance</option>
                            <option value="okx">OKX</option>
                            <option value="huobi">Huobi</option>
                            <option value="bybit">Bybit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>é»˜è®¤äº¤æ˜“å¯¹</label>
                        <input type="text" id="defaultSymbol" value="BTC/USDT">
                    </div>
                </div>
                
                <h3>é£é™©æ§åˆ¶å…¨å±€é…ç½®</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>æœ€å¤§ä»“ä½é™åˆ¶ï¼ˆUSDTï¼‰</label>
                        <input type="number" id="maxPosition" value="10000">
                    </div>
                    <div class="form-group">
                        <label>å•æ—¥æœ€å¤§äºæŸï¼ˆUSDTï¼‰</label>
                        <input type="number" id="maxDailyLoss" value="1000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å…¨å±€æ­¢æŸæ¯”ä¾‹ï¼ˆ%ï¼‰</label>
                        <input type="number" id="globalStopLoss" value="5" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>å…¨å±€æ­¢ç›ˆæ¯”ä¾‹ï¼ˆ%ï¼‰</label>
                        <input type="number" id="globalTakeProfit" value="10" step="0.1">
                    </div>
                </div>
                
                <h3>ç³»ç»Ÿä¼˜åŒ–å»ºè®®</h3>
                <div id="optimizationSuggestions" style="padding:10px;background:#f9f9f9;border:1px solid #ddd;margin-bottom:10px;">
                    <p>ç‚¹å‡»"è·å–ä¼˜åŒ–å»ºè®®"æŒ‰é’®æŸ¥çœ‹ç³»ç»Ÿä¼˜åŒ–å»ºè®®</p>
                </div>
                <button class="btn" onclick="getOptimizationSuggestions()">è·å–ä¼˜åŒ–å»ºè®®</button>
                
                <h3>æ“ä½œ</h3>
                <div class="form-row">
                    <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                    <button class="btn" onclick="resetSettings()">é‡ç½®é»˜è®¤</button>
                    <button class="btn" onclick="exportSettings()">å¯¼å‡ºé…ç½®</button>
                    <button class="btn" onclick="importSettings()">å¯¼å…¥é…ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºæœºå™¨äººæ¨¡æ€æ¡† -->
    <div id="createBotModal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºæœºå™¨äºº</h3>
            <div class="form-group">
                <label>æœºå™¨äººåç§°</label>
                <input type="text" id="botName" placeholder="æœºå™¨äººåç§°">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>äº¤æ˜“æ‰€</label>
                    <select id="botExchange"><option value="binance">Binance</option><option value="okx">OKX</option></select>
                </div>
                <div class="form-group">
                    <label>äº¤æ˜“å¯¹</label>
                    <input type="text" id="botSymbol" placeholder="BTC/USDT">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ç­–ç•¥ç±»å‹</label>
                    <select id="botStrategy"><option value="code_a">Code Aç­–ç•¥</option></select>
                </div>
                <div class="form-group">
                    <label>æŠ•èµ„é‡‘é¢(USDT)</label>
                    <input type="number" id="botInvestment" value="1000" oninput="calculateTradingCost()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ç½‘æ ¼å±‚æ•°</label>
                    <input type="number" id="botGridLevels" value="10">
                </div>
                <div class="form-group">
                    <label>ç½‘æ ¼é—´è·(%)</label>
                    <input type="number" id="botGridSpacing" value="2" step="0.1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>é˜ˆå€¼(%)</label>
                    <input type="number" id="botThreshold" value="1" step="0.1">
                </div>
                <div class="form-group">
                    <label>æ­¢æŸé˜ˆå€¼(%)</label>
                    <input type="number" id="botStopLoss" value="5" step="0.1" oninput="calculateTradingCost()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ­¢ç›ˆé˜ˆå€¼(%)</label>
                    <input type="number" id="botTakeProfit" value="10" step="0.1">
                </div>
                <div class="form-group">
                    <label>æœ€å¤§ä»“ä½(USDT)</label>
                    <input type="number" id="botMaxPosition" value="10000" oninput="calculateTradingCost()">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ‰‹ç»­è´¹ç‡(%)</label>
                    <input type="number" id="botCommissionRate" value="0.1" step="0.01" oninput="calculateTradingCost()">
                </div>
                <div class="form-group">
                    <label>æ»‘ç‚¹ç‡(%)</label>
                    <input type="number" id="botSlippageRate" value="0.05" step="0.01" oninput="calculateTradingCost()">
                </div>
            </div>
            
            <!-- äº¤æ˜“æˆæœ¬é¢„ä¼° -->
            <div style="margin-top: 15px; padding: 12px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px;">
                <h4 style="margin: 0 0 10px 0; font-size: 14px; font-weight: bold;">ğŸ’° äº¤æ˜“æˆæœ¬é¢„ä¼°</h4>
                <div class="form-row" style="margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <span style="font-size: 11px; color: #666;">æŠ•èµ„é‡‘é¢:</span><br>
                        <strong id="costInvestment" style="font-size: 14px;">1000 USDT</strong>
                    </div>
                    <div style="flex: 1;">
                        <span style="font-size: 11px; color: #666;">å•ç¬”æ‰‹ç»­è´¹:</span><br>
                        <strong id="costCommission" style="font-size: 14px;">1.00 USDT</strong>
                    </div>
                    <div style="flex: 1;">
                        <span style="font-size: 11px; color: #666;">å•ç¬”æ»‘ç‚¹æˆæœ¬:</span><br>
                        <strong id="costSlippage" style="font-size: 14px;">0.50 USDT</strong>
                    </div>
                </div>
                <div class="form-row" style="margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <span style="font-size: 11px; color: #666;">æ­¢æŸé¢„ä¼°æŸå¤±:</span><br>
                        <strong id="costStopLoss" style="font-size: 14px; color: #dc3545;">50.00 USDT (5.0%)</strong>
                    </div>
                    <div style="flex: 1;">
                        <span style="font-size: 11px; color: #666;">æœ€å¤§æŒä»“æˆæœ¬:</span><br>
                        <strong id="costMaxPosition" style="font-size: 14px; color: #007bff;">10000 USDT</strong>
                    </div>
                </div>
                <div class="form-row">
                    <div style="flex: 1;">
                        <span style="font-size: 11px; color: #666;">æ€»é¢„ä¼°æˆæœ¬(å•æ¬¡å®Œæ•´äº¤æ˜“):</span><br>
                        <strong id="costTotal" style="font-size: 16px; color: #dc3545;">103.00 USDT (10.3%)</strong>
                    </div>
                </div>
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 11px; color: #666;">
                    â„¹ï¸ <strong>è¯´æ˜ï¼š</strong>æˆæœ¬åŸºäºå½“å‰å‚æ•°é¢„ä¼°ï¼Œå®é™…æˆæœ¬å¯èƒ½å› å¸‚åœºæ³¢åŠ¨è€Œå˜åŒ–
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('createBotModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createBot()">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <!-- å›æµ‹æ¨¡æ€æ¡† -->
    <div id="backtestModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å»ºå›æµ‹</h3>
            <div class="form-group">
                <label>ç­–ç•¥ç±»å‹</label>
                <select id="backtestStrategy"><option value="code_a">Code Aç­–ç•¥</option></select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>äº¤æ˜“å¯¹</label>
                    <input type="text" id="backtestSymbol" value="BTC/USDT">
                </div>
                <div class="form-group">
                    <label>æ—¶é—´å‘¨æœŸ</label>
                    <select id="backtestTimeframe"><option value="1h">1å°æ—¶</option><option value="4h">4å°æ—¶</option><option value="1d">1å¤©</option></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å¼€å§‹æ—¶é—´</label>
                    <input type="date" id="backtestStartTime">
                </div>
                <div class="form-group">
                    <label>ç»“æŸæ—¶é—´</label>
                    <input type="date" id="backtestEndTime">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ç½‘æ ¼å±‚æ•°</label>
                    <input type="number" id="backtestGridLevels" value="10">
                </div>
                <div class="form-group">
                    <label>ç½‘æ ¼é—´è·(%)</label>
                    <input type="number" id="backtestGridSpacing" value="2" step="0.1">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('backtestModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="runBacktest()">è¿è¡Œå›æµ‹</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ äº¤æ˜“æ‰€æ¨¡æ€æ¡† -->
    <div id="addExchangeModal" class="modal">
        <div class="modal-content">
            <h3>æ·»åŠ äº¤æ˜“æ‰€</h3>
            <div class="form-group">
                <label>äº¤æ˜“æ‰€åç§°</label>
                <input type="text" id="exchangeName" placeholder="äº¤æ˜“æ‰€åç§°">
            </div>
            <div class="form-group">
                <label>äº¤æ˜“æ‰€ç±»å‹</label>
                <select id="exchangeType"><option value="binance">Binance</option><option value="okx">OKX</option></select>
            </div>
            <div class="form-group">
                <label>API Key</label>
                <input type="text" id="exchangeApiKey" placeholder="API Key">
            </div>
            <div class="form-group">
                <label>API Secret</label>
                <input type="password" id="exchangeApiSecret" placeholder="API Secret">
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('addExchangeModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addExchange()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºç”¨æˆ·</h3>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="newUsername" placeholder="ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>é‚®ç®±</label>
                <input type="email" id="newUserEmail" placeholder="é‚®ç®±">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="newUserPassword" placeholder="å¯†ç ">
            </div>
            <div class="form-group">
                <label>è§’è‰²</label>
                <select id="newUserRole"><option value="user">æ™®é€šç”¨æˆ·</option><option value="admin">ç®¡ç†å‘˜</option></select>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('createUserModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createUser()">åˆ›å»º</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ é€šçŸ¥é…ç½®æ¨¡æ€æ¡† -->
    <div id="addNotificationModal" class="modal">
        <div class="modal-content">
            <h3>æ·»åŠ é€šçŸ¥é…ç½®</h3>
            <div class="form-group">
                <label>é€šçŸ¥æ¸ é“</label>
                <select id="notificationChannel" onchange="updateNotificationFields()">
                    <option value="email">é‚®ä»¶</option>
                    <option value="dingtalk">é’‰é’‰</option>
                    <option value="feishu">é£ä¹¦</option>
                    <option value="telegram">Telegram</option>
                    <option value="webhook">Webhook</option>
                </select>
            </div>
            <div id="notificationEmailFields">
                <div class="form-group">
                    <label>SMTPæœåŠ¡å™¨</label>
                    <input type="text" id="smtpServer" placeholder="smtp.gmail.com">
                </div>
                <div class="form-group">
                    <label>SMTPç«¯å£</label>
                    <input type="number" id="smtpPort" value="587">
                </div>
                <div class="form-group">
                    <label>å‘ä»¶äººé‚®ç®±</label>
                    <input type="email" id="senderEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>é‚®ç®±å¯†ç /æˆæƒç </label>
                    <input type="password" id="emailPassword" placeholder="é‚®ç®±å¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç ">
                </div>
                <div class="form-group">
                    <label>æ”¶ä»¶äººé‚®ç®±</label>
                    <input type="text" id="receiverEmail" placeholder="receiver@email.com">
                </div>
            </div>
            <div id="notificationDingtalkFields" style="display:none;">
                <div class="form-group">
                    <label>é’‰é’‰Webhook URL</label>
                    <input type="text" id="dingtalkWebhook" placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                </div>
                <div class="form-group">
                    <label>å¯†é’¥ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="dingtalkSecret" placeholder="åŠ ç­¾å¯†é’¥">
                </div>
            </div>
            <div id="notificationFeishuFields" style="display:none;">
                <div class="form-group">
                    <label>é£ä¹¦Webhook URL</label>
                    <input type="text" id="feishuWebhook" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/...">
                </div>
            </div>
            <div id="notificationTelegramFields" style="display:none;">
                <div class="form-group">
                    <label>Bot Token</label>
                    <input type="text" id="telegramBotToken" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11">
                </div>
                <div class="form-group">
                    <label>Chat ID</label>
                    <input type="text" id="telegramChatId" placeholder="123456789">
                </div>
            </div>
            <div id="notificationWebhookFields" style="display:none;">
                <div class="form-group">
                    <label>Webhook URL</label>
                    <input type="text" id="webhookUrl" placeholder="https://your-server.com/webhook">
                </div>
                <div class="form-group">
                    <label>Headers (JSON)</label>
                    <textarea id="webhookHeaders" rows="3" placeholder='{"Authorization": "Bearer xxx"}'></textarea>
                </div>
            </div>
            <div class="form-group">
                <label>è§¦å‘äº‹ä»¶</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <label><input type="checkbox" value="trade" checked> äº¤æ˜“æˆäº¤</label>
                    <label><input type="checkbox" value="risk"> é£é™©é¢„è­¦</label>
                    <label><input type="checkbox" value="system"> ç³»ç»Ÿå¼‚å¸¸</label>
                    <label><input type="checkbox" value="bot"> æœºå™¨äººå¯åœ</label>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('addNotificationModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addNotification()">æ·»åŠ </button>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºç­–ç•¥æ¨¡æ€æ¡† -->
    <div id="createStrategyModal" class="modal">
        <div class="modal-content">
            <h3>åˆ›å»ºè‡ªå®šä¹‰ç­–ç•¥</h3>
            <div class="form-group">
                <label>ç­–ç•¥åç§°</label>
                <input type="text" id="strategyName" placeholder="æˆ‘çš„ç­–ç•¥">
            </div>
            <div class="form-group">
                <label>ç­–ç•¥ç±»å‹</label>
                <select id="strategyType">
                    <option value="custom">è‡ªå®šä¹‰</option>
                    <option value="grid">ç½‘æ ¼ç­–ç•¥</option>
                    <option value="momentum">åŠ¨é‡ç­–ç•¥</option>
                    <option value="mean_reversion">å‡å€¼å›å½’</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç­–ç•¥æè¿°</label>
                <textarea id="strategyDescription" rows="3" placeholder="ç­–ç•¥è¯´æ˜..."></textarea>
            </div>
            <div class="form-group">
                <label>ç­–ç•¥å‚æ•°ï¼ˆJSONï¼‰</label>
                <textarea id="strategyParameters" rows="6" placeholder='{"grid_levels": 10, "grid_spacing": 0.02}'></textarea>
            </div>
            <div class="form-group">
                <label>ç­–ç•¥ä»£ç ï¼ˆPythonï¼‰</label>
                <textarea id="strategyCode" rows="10" placeholder="def strategy(context):&#10;    # ç­–ç•¥é€»è¾‘&#10;    pass"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('createStrategyModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createStrategy()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('token');
        
        // ç™»å½•
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                if (data.access_token) {
                    authToken = data.access_token;
                    localStorage.setItem('token', authToken);
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('mainSection').style.display = 'block';
                    loadDashboard();
                } else {
                    alert('ç™»å½•å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('ç™»å½•å¤±è´¥: ' + e.message);
            }
        }
        
        // é€€å‡º
        function logout() {
            localStorage.removeItem('token');
            authToken = null;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainSection').style.display = 'none';
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (authToken) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            loadDashboard();
        }
        
        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            switch(tabId) {
                case 'dashboard': loadDashboard(); break;
                case 'bots': refreshBots(); break;
                case 'trades': refreshTrades(); break;
                case 'orders': refreshOrders(); break;
                case 'exchanges': refreshExchanges(); break;
                case 'risk': refreshRisk(); break;
                case 'backtest': refreshBacktests(); break;
                case 'strategies': refreshStrategies(); break;
                case 'analytics': refreshAnalytics(); break;
                case 'users': refreshUsers(); break;
                case 'audit': refreshAuditLogs(); break;
                case 'performance': refreshPerformance(); break;
                case 'database': refreshDatabase(); break;
                case 'logs': refreshLogs(); break;
                case 'notifications': refreshNotifications(); break;
            }
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜
        async function loadDashboard() {
            try {
                const [botsRes, tradesRes] = await Promise.all([
                    fetch(`${API_BASE}/bots`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                    fetch(`${API_BASE}/trades/recent?limit=10`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                ]);
                
                const bots = await botsRes.json();
                const trades = await tradesRes.json();
                
                // ç»Ÿè®¡æ•°æ®
                const totalProfit = bots.reduce((sum, b) => sum + (b.total_profit || 0), 0);
                const runningCount = bots.filter(b => b.status === 'running').length;
                const stoppedCount = bots.filter(b => b.status === 'stopped').length;
                
                document.getElementById('dashboardStats').innerHTML = `
                    <div class="stat-box"><strong>${bots.length}</strong><span>æœºå™¨äººæ€»æ•°</span></div>
                    <div class="stat-box"><strong>${runningCount}</strong><span>è¿è¡Œä¸­</span></div>
                    <div class="stat-box"><strong>${stoppedCount}</strong><span>å·²åœæ­¢</span></div>
                    <div class="stat-box"><strong>${totalProfit.toFixed(2)}</strong><span>æ€»åˆ©æ¶¦(USDT)</span></div>
                    <div class="stat-box"><strong>${trades.length}</strong><span>ä»Šæ—¥äº¤æ˜“</span></div>
                    <div class="stat-box"><strong>99.9%</strong><span>ç³»ç»Ÿæ­£å¸¸</span></div>
                `;
                
                // æœ€è¿‘äº¤æ˜“
                const tbody = document.querySelector('#recentTrades tbody');
                tbody.innerHTML = trades.map(t => `
                    <tr>
                        <td>${new Date(t.created_at).toLocaleString()}</td>
                        <td>${t.bot_name || '-'}</td>
                        <td>${t.symbol || '-'}</td>
                        <td>${t.side || '-'}</td>
                        <td>${t.price || '-'}</td>
                        <td>${t.amount || '-'}</td>
                        <td class="${t.profit >= 0 ? 'profit-pos' : 'profit-neg'}">${t.profit || '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥:', e);
            }
        }
        
        // æœºå™¨äººç®¡ç†
        async function refreshBots() {
            try {
                const res = await fetch(`${API_BASE}/bots`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                const bots = await res.json();
                
                const tbody = document.querySelector('#botsTable tbody');
                tbody.innerHTML = bots.map(b => `
                    <tr>
                        <td>${b.id}</td>
                        <td>${b.name}</td>
                        <td>${b.exchange_id}</td>
                        <td>${b.symbol}</td>
                        <td>${b.strategy_type}</td>
                        <td class="${b.status === 'running' ? 'status-running' : 'status-stopped'}">${b.status}</td>
                        <td class="${b.total_profit >= 0 ? 'profit-pos' : 'profit-neg'}">${(b.total_profit || 0).toFixed(2)}</td>
                        <td>
                            ${b.status === 'stopped' ? `<button class="btn btn-success" onclick="startBot(${b.id})">å¯åŠ¨</button>` : `<button class="btn btn-danger" onclick="stopBot(${b.id})">åœæ­¢</button>`}
                            <button class="btn" onclick="viewBotStatus(${b.id})">çŠ¶æ€</button>
                            <button class="btn btn-danger" onclick="deleteBot(${b.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°æœºå™¨äººå¤±è´¥:', e);
            }
        }
        
        async function startBot(botId) {
            try {
                const res = await fetch(`${API_BASE}/bots/${botId}/start`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æœºå™¨äººå¯åŠ¨æˆåŠŸ');
                    refreshBots();
                } else {
                    alert('å¯åŠ¨å¤±è´¥');
                }
            } catch (e) {
                alert('å¯åŠ¨å¤±è´¥: ' + e.message);
            }
        }
        
        async function stopBot(botId) {
            try {
                const res = await fetch(`${API_BASE}/bots/${botId}/stop`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æœºå™¨äººå·²åœæ­¢');
                    refreshBots();
                } else {
                    alert('åœæ­¢å¤±è´¥');
                }
            } catch (e) {
                alert('åœæ­¢å¤±è´¥: ' + e.message);
            }
        }
        
        async function deleteBot(botId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæœºå™¨äººå—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/bots/${botId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æœºå™¨äººå·²åˆ é™¤');
                    refreshBots();
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥');
            }
        }
        
        // è®¡ç®—äº¤æ˜“æˆæœ¬é¢„ä¼°
        function calculateTradingCost() {
            const investment = parseFloat(document.getElementById('botInvestment').value) || 0;
            const stopLossPercent = parseFloat(document.getElementById('botStopLoss').value) || 0;
            const maxPosition = parseFloat(document.getElementById('botMaxPosition').value) || 0;
            const commissionRate = parseFloat(document.getElementById('botCommissionRate').value) || 0;
            const slippageRate = parseFloat(document.getElementById('botSlippageRate').value) || 0;
            
            // è®¡ç®—å„é¡¹æˆæœ¬
            const commission = investment * (commissionRate / 100); // å•ç¬”æ‰‹ç»­è´¹
            const slippage = investment * (slippageRate / 100); // å•ç¬”æ»‘ç‚¹æˆæœ¬
            const stopLoss = investment * (stopLossPercent / 100); // æ­¢æŸé¢„ä¼°æŸå¤±
            
            // å®Œæ•´äº¤æ˜“åŒ…å«ï¼šä¹°å…¥(æ‰‹ç»­è´¹+æ»‘ç‚¹) + å–å‡º(æ‰‹ç»­è´¹+æ»‘ç‚¹) + æ­¢æŸé£é™©
            // å®é™…ä¸Šåªæœ‰æ­¢æŸæ‰ä¼šè§¦å‘æŸå¤±ï¼Œè¿™é‡ŒæŒ‰æœ€åæƒ…å†µé¢„ä¼°
            const totalCommission = commission * 2; // ä¹°å…¥å’Œå–å‡º
            const totalSlippage = slippage * 2; // ä¹°å…¥å’Œå–å‡º
            const totalCost = totalCommission + totalSlippage + stopLoss; // æ€»é¢„ä¼°æˆæœ¬
            const totalPercent = investment > 0 ? (totalCost / investment * 100) : 0;
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('costInvestment').textContent = `${investment.toFixed(2)} USDT`;
            document.getElementById('costCommission').textContent = `${commission.toFixed(2)} USDT`;
            document.getElementById('costSlippage').textContent = `${slippage.toFixed(2)} USDT`;
            document.getElementById('costStopLoss').textContent = `${stopLoss.toFixed(2)} USDT (${stopLossPercent.toFixed(1)}%)`;
            document.getElementById('costMaxPosition').textContent = `${maxPosition.toFixed(2)} USDT`;
            document.getElementById('costTotal').textContent = `${totalCost.toFixed(2)} USDT (${totalPercent.toFixed(1)}%)`;
        }
        
        async function createBot() {
            const config = {
                investment_amount: parseFloat(document.getElementById('botInvestment').value),
                grid_levels: parseInt(document.getElementById('botGridLevels').value),
                grid_spacing: parseFloat(document.getElementById('botGridSpacing').value) / 100,
                threshold: parseFloat(document.getElementById('botThreshold').value) / 100,
                stop_loss_threshold: parseFloat(document.getElementById('botStopLoss').value) / 100,
                take_profit_threshold: parseFloat(document.getElementById('botTakeProfit').value) / 100,
                max_position: parseFloat(document.getElementById('botMaxPosition').value),
                commission_rate: parseFloat(document.getElementById('botCommissionRate').value) / 100,
                slippage_rate: parseFloat(document.getElementById('botSlippageRate').value) / 100
            };
            
            const data = {
                name: document.getElementById('botName').value,
                exchange: document.getElementById('botExchange').value,
                trading_pair: document.getElementById('botSymbol').value,
                strategy: document.getElementById('botStrategy').value,
                config: config
            };
            
            try {
                const res = await fetch(`${API_BASE}/bots`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('æœºå™¨äººåˆ›å»ºæˆåŠŸ');
                    closeModal('createBotModal');
                    refreshBots();
                } else {
                    alert('åˆ›å»ºå¤±è´¥');
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }
        
        // äº¤æ˜“è®°å½•
        async function refreshTrades() {
            try {
                const res = await fetch(`${API_BASE}/trades/recent?limit=50`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const trades = await res.json();
                
                const tbody = document.querySelector('#tradesTable tbody');
                tbody.innerHTML = trades.map(t => `
                    <tr>
                        <td>${new Date(t.created_at).toLocaleString()}</td>
                        <td>${t.bot_name || '-'}</td>
                        <td>${t.symbol || '-'}</td>
                        <td>${t.side || '-'}</td>
                        <td>${t.price || '-'}</td>
                        <td>${t.amount || '-'}</td>
                        <td class="${t.profit >= 0 ? 'profit-pos' : 'profit-neg'}">${t.profit || '-'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°äº¤æ˜“è®°å½•å¤±è´¥:', e);
            }
        }
        
        // è®¢å•ç®¡ç†
        async function refreshOrders() {
            try {
                const res = await fetch(`${API_BASE}/orders`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const orders = await res.json();
                
                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = orders.map(o => `
                    <tr>
                        <td>${o.id}</td>
                        <td>${o.bot_id || '-'}</td>
                        <td>${o.symbol || '-'}</td>
                        <td>${o.order_type || '-'}</td>
                        <td>${o.side || '-'}</td>
                        <td>${o.price || '-'}</td>
                        <td>${o.amount || '-'}</td>
                        <td>${o.status || '-'}</td>
                        <td><button class="btn btn-danger" onclick="cancelOrder(${o.id})">å–æ¶ˆ</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°è®¢å•å¤±è´¥:', e);
            }
        }
        
        // äº¤æ˜“æ‰€ç®¡ç†
        async function refreshExchanges() {
            try {
                const res = await fetch(`${API_BASE}/exchange`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const exchanges = await res.json();
                
                const tbody = document.querySelector('#exchangesTable tbody');
                tbody.innerHTML = exchanges.map(e => `
                    <tr>
                        <td>${e.id}</td>
                        <td>${e.name}</td>
                        <td>${e.exchange_id}</td>
                        <td>${e.api_key ? '***' + e.api_key.slice(-4) : '-'}</td>
                        <td>${e.status || 'active'}</td>
                        <td>
                            <button class="btn" onclick="testExchange(${e.id})">æµ‹è¯•</button>
                            <button class="btn btn-danger" onclick="deleteExchange(${e.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°äº¤æ˜“æ‰€å¤±è´¥:', e);
            }
        }
        
        async function addExchange() {
            const data = {
                name: document.getElementById('exchangeName').value,
                exchange_id: document.getElementById('exchangeType').value,
                api_key: document.getElementById('exchangeApiKey').value,
                api_secret: document.getElementById('exchangeApiSecret').value
            };
            
            try {
                const res = await fetch(`${API_BASE}/exchange`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('äº¤æ˜“æ‰€æ·»åŠ æˆåŠŸ');
                    closeModal('addExchangeModal');
                    refreshExchanges();
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }
        
        // ç”¨æˆ·ç®¡ç†
        async function refreshUsers() {
            try {
                const res = await fetch(`${API_BASE}/rbac/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const users = await res.json();
                
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${u.role}</td>
                        <td>${u.is_active ? 'active' : 'inactive'}</td>
                        <td>${new Date(u.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn" onclick="editUser(${u.id})">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteUser(${u.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°ç”¨æˆ·å¤±è´¥:', e);
            }
        }
        
        async function createUser() {
            const data = {
                username: document.getElementById('newUsername').value,
                email: document.getElementById('newUserEmail').value,
                password: document.getElementById('newUserPassword').value,
                role: document.getElementById('newUserRole').value
            };
            
            try {
                const res = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
                    closeModal('createUserModal');
                    refreshUsers();
                } else {
                    alert('åˆ›å»ºå¤±è´¥');
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }
        
        // æ€§èƒ½ç›‘æ§
        async function refreshPerformance() {
            try {
                const res = await fetch(`${API_BASE}/performance/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const stats = await res.json();
                
                document.getElementById('performanceStats').innerHTML = `
                    <div class="stat-box"><strong>${stats.cpu_usage || 0}%</strong><span>CPUä½¿ç”¨ç‡</span></div>
                    <div class="stat-box"><strong>${stats.memory_usage || 0}%</strong><span>å†…å­˜ä½¿ç”¨ç‡</span></div>
                    <div class="stat-box"><strong>${stats.disk_usage || 0}%</strong><span>ç£ç›˜ä½¿ç”¨ç‡</span></div>
                    <div class="stat-box"><strong>${stats.active_connections || 0}</strong><span>æ´»è·ƒè¿æ¥</span></div>
                `;
                
                const tbody = document.querySelector('#performanceTable tbody');
                tbody.innerHTML = `
                    <tr><td>APIå“åº”æ—¶é—´</td><td>${stats.api_response_time || 0}ms</td><td>1000ms</td><td class="status-running">æ­£å¸¸</td></tr>
                    <tr><td>æ•°æ®åº“è¿æ¥</td><td>${stats.db_connections || 0}</td><td>100</td><td class="status-running">æ­£å¸¸</td></tr>
                    <tr><td>ç¼“å­˜å‘½ä¸­ç‡</td><td>${stats.cache_hit_rate || 0}%</td><td>80%</td><td class="status-running">æ­£å¸¸</td></tr>
                `;
            } catch (e) {
                console.error('åˆ·æ–°æ€§èƒ½æ•°æ®å¤±è´¥:', e);
            }
        }
        
        // æ•°æ®åº“ç®¡ç†
        async function backupDatabase() {
            if (!confirm('ç¡®å®šè¦å¤‡ä»½æ•°æ®åº“å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${API_BASE}/database-manager/backup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æ•°æ®åº“å¤‡ä»½æˆåŠŸ');
                    refreshDatabase();
                } else {
                    alert('å¤‡ä»½å¤±è´¥');
                }
            } catch (e) {
                alert('å¤‡ä»½å¤±è´¥: ' + e.message);
            }
        }
        
        async function optimizeDatabase() {
            if (!confirm('ç¡®å®šè¦ä¼˜åŒ–æ•°æ®åº“å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) return;
            try {
                const res = await fetch(`${API_BASE}/database-manager/optimize`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æ•°æ®åº“ä¼˜åŒ–æˆåŠŸ');
                } else {
                    alert('ä¼˜åŒ–å¤±è´¥');
                }
            } catch (e) {
                alert('ä¼˜åŒ–å¤±è´¥: ' + e.message);
            }
        }
        
        async function refreshDatabase() {
            try {
                const res = await fetch(`${API_BASE}/database-manager/backups`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const backups = await res.json();
                
                const tbody = document.querySelector('#dbBackupsTable tbody');
                tbody.innerHTML = backups.map(b => `
                    <tr>
                        <td>${b.filename}</td>
                        <td>${b.size}</td>
                        <td>${new Date(b.created_at).toLocaleString()}</td>
                        <td><button class="btn" onclick="restoreBackup('${b.filename}')">æ¢å¤</button><button class="btn btn-danger" onclick="deleteBackup('${b.filename}')">åˆ é™¤</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°æ•°æ®åº“ä¿¡æ¯å¤±è´¥:', e);
            }
        }
        
        // æ¨¡æ€æ¡†æ§åˆ¶
        function showCreateBotModal() { 
            document.getElementById('createBotModal').classList.add('active');
            // åˆå§‹åŒ–æˆæœ¬è®¡ç®—
            calculateTradingCost();
        }
        function showBacktestModal() { document.getElementById('backtestModal').classList.add('active'); }
        function showAddExchangeModal() { document.getElementById('addExchangeModal').classList.add('active'); }
        function showCreateUserModal() { document.getElementById('createUserModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // å›æµ‹
        async function runBacktest() {
            const data = {
                strategy_type: document.getElementById('backtestStrategy').value,
                symbol: document.getElementById('backtestSymbol').value,
                timeframe: document.getElementById('backtestTimeframe').value,
                start_time: document.getElementById('backtestStartTime').value,
                end_time: document.getElementById('backtestEndTime').value,
                grid_levels: parseInt(document.getElementById('backtestGridLevels').value),
                grid_spacing: parseFloat(document.getElementById('backtestGridSpacing').value) / 100
            };
            
            try {
                const res = await fetch(`${API_BASE}/backtest/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('å›æµ‹ä»»åŠ¡å·²æäº¤');
                    closeModal('backtestModal');
                    refreshBacktests();
                } else {
                    alert('æäº¤å¤±è´¥');
                }
            } catch (e) {
                alert('æäº¤å¤±è´¥: ' + e.message);
            }
        }
        
        async function refreshBacktests() {
            // ç®€åŒ–å®ç°
            document.querySelector('#backtestsTable tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;">æš‚æ— å›æµ‹è®°å½•</td></tr>';
        }
        
        // è®¢å•ç®¡ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshOrders() {
            try {
                const statusFilter = document.getElementById('orderStatusFilter')?.value || '';
                const botFilter = document.getElementById('orderBotFilter')?.value || '';
                
                let url = `${API_BASE}/orders`;
                const params = new URLSearchParams();
                if (statusFilter) params.append('status', statusFilter);
                if (botFilter) params.append('bot_id', botFilter);
                if (params.toString()) url += '?' + params.toString();
                
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const orders = await res.json();
                
                const tbody = document.querySelector('#ordersTable tbody');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">æš‚æ— è®¢å•</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orders.map(o => `
                    <tr>
                        <td>${o.id}</td>
                        <td>${o.bot_name || '-'}</td>
                        <td>${o.symbol || '-'}</td>
                        <td>${o.order_type || '-'}</td>
                        <td>${o.side || '-'}</td>
                        <td>${o.price || '-'}</td>
                        <td>${o.amount || '-'}</td>
                        <td>${o.status || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="cancelOrder(${o.id})">å–æ¶ˆ</button>
                            <button class="btn" onclick="viewOrderDetail(${o.id})">è¯¦æƒ…</button>
                        </td>
                    </tr>
                `).join('');
                
                // æ›´æ–°æœºå™¨äººç­›é€‰å™¨
                updateOrderBotFilter(orders);
            } catch (e) {
                console.error('åˆ·æ–°è®¢å•å¤±è´¥:', e);
                document.querySelector('#ordersTable tbody').innerHTML = '<tr><td colspan="9" style="text-align:center;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        async function cancelOrder(orderId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${API_BASE}/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('è®¢å•å·²å–æ¶ˆ');
                    refreshOrders();
                } else {
                    alert('å–æ¶ˆå¤±è´¥');
                }
            } catch (e) {
                alert('å–æ¶ˆå¤±è´¥: ' + e.message);
            }
        }
        
        async function cancelAllOrders() {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆæ‰€æœ‰è®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            try {
                const res = await fetch(`${API_BASE}/orders/cancel-all`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æ‰€æœ‰è®¢å•å·²å–æ¶ˆ');
                    refreshOrders();
                } else {
                    alert('å–æ¶ˆå¤±è´¥');
                }
            } catch (e) {
                alert('å–æ¶ˆå¤±è´¥: ' + e.message);
            }
        }
        
        function updateOrderBotFilter(orders) {
            const botSelect = document.getElementById('orderBotFilter');
            if (!botSelect) return;
            
            const bots = [...new Set(orders.map(o => o.bot_id).filter(id => id))];
            const currentValue = botSelect.value;
            botSelect.innerHTML = '<option value="">å…¨éƒ¨æœºå™¨äºº</option>' + 
                bots.map(id => `<option value="${id}">${id}</option>`).join('');
            botSelect.value = currentValue;
        }
        
        // é£é™©ç®¡ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshRisk() {
            try {
                const res = await fetch(`${API_BASE}/risk/overview`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const riskData = await res.json();
                
                // é£é™©æ¦‚è§ˆç»Ÿè®¡
                if (riskData.stats) {
                    document.getElementById('riskStats').innerHTML = `
                        <div class="stat-box"><strong>${(riskData.stats.total_value || 0).toFixed(2)}</strong><span>è´¦æˆ·æ€»ä»·å€¼(USDT)</span></div>
                        <div class="stat-box"><strong class="${riskData.stats.total_unrealized_pnl >= 0 ? 'profit-pos' : 'profit-neg'}">${(riskData.stats.total_unrealized_pnl || 0).toFixed(2)}</strong><span>æœªå®ç°ç›ˆäº</span></div>
                        <div class="stat-box"><strong>${riskData.stats.total_positions || 0}</strong><span>æŒä»“æ•°é‡</span></div>
                        <div class="stat-box"><strong>${riskData.stats.risk_level || 'ä½'}</strong><span>é£é™©ç­‰çº§</span></div>
                        <div class="stat-box"><strong>${(riskData.stats.max_drawdown || 0).toFixed(2)}%</strong><span>æœ€å¤§å›æ’¤</span></div>
                        <div class="stat-box"><strong>${(riskData.stats.sharpe_ratio || 0).toFixed(2)}</strong><span>å¤æ™®æ¯”ç‡</span></div>
                    `;
                }
                
                // æŒä»“é£é™©è¯¦æƒ…
                if (riskData.positions && riskData.positions.length > 0) {
                    const tbody = document.querySelector('#riskTable tbody');
                    tbody.innerHTML = riskData.positions.map(p => `
                        <tr>
                            <td>${p.bot_name || '-'}</td>
                            <td>${(p.position_value || 0).toFixed(2)}</td>
                            <td class="${p.unrealized_pnl >= 0 ? 'profit-pos' : 'profit-neg'}">${(p.unrealized_pnl || 0).toFixed(2)}</td>
                            <td>${p.risk_level || '-'}</td>
                            <td>${p.position_limit || '-'}</td>
                            <td>
                                <button class="btn" onclick="editStopLoss('${p.bot_id}')">æ­¢æŸ</button>
                                <button class="btn" onclick="editTakeProfit('${p.bot_id}')">æ­¢ç›ˆ</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    document.querySelector('#riskTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;">æš‚æ— æŒä»“</td></tr>';
                }
            } catch (e) {
                console.error('åˆ·æ–°é£é™©æ•°æ®å¤±è´¥:', e);
                document.querySelector('#riskTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        async function editStopLoss(botId) {
            const value = prompt('è¯·è¾“å…¥æ­¢æŸä»·æ ¼ï¼ˆç•™ç©ºåˆ™ä¸è®¾ç½®ï¼‰ï¼š');
            if (value === null) return;
            
            try {
                const res = await fetch(`${API_BASE}/risk/stop-loss`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ bot_id: botId, stop_loss: value ? parseFloat(value) : null })
                });
                if (res.ok) {
                    alert('æ­¢æŸè®¾ç½®æˆåŠŸ');
                    refreshRisk();
                } else {
                    alert('è®¾ç½®å¤±è´¥');
                }
            } catch (e) {
                alert('è®¾ç½®å¤±è´¥: ' + e.message);
            }
        }
        
        async function editTakeProfit(botId) {
            const value = prompt('è¯·è¾“å…¥æ­¢ç›ˆä»·æ ¼ï¼ˆç•™ç©ºåˆ™ä¸è®¾ç½®ï¼‰ï¼š');
            if (value === null) return;
            
            try {
                const res = await fetch(`${API_BASE}/risk/take-profit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ bot_id: botId, take_profit: value ? parseFloat(value) : null })
                });
                if (res.ok) {
                    alert('æ­¢ç›ˆè®¾ç½®æˆåŠŸ');
                    refreshRisk();
                } else {
                    alert('è®¾ç½®å¤±è´¥');
                }
            } catch (e) {
                alert('è®¾ç½®å¤±è´¥: ' + e.message);
            }
        }
        
        async function closeAllPositions() {
            if (!confirm('ç¡®å®šè¦å¹³ä»“æ‰€æœ‰æŒä»“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            try {
                const res = await fetch(`${API_BASE}/risk/close-all`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æ‰€æœ‰æŒä»“å·²å¹³ä»“');
                    refreshRisk();
                } else {
                    alert('å¹³ä»“å¤±è´¥');
                }
            } catch (e) {
                alert('å¹³ä»“å¤±è´¥: ' + e.message);
            }
        }
        
        // é«˜çº§ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshStrategies() {
            try {
                const res = await fetch(`${API_BASE}/strategies`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const strategies = await res.json();
                
                const tbody = document.querySelector('#strategiesTable tbody');
                if (!strategies || strategies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">æš‚æ— è‡ªå®šä¹‰ç­–ç•¥</td></tr>';
                    return;
                }
                
                tbody.innerHTML = strategies.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.type}</td>
                        <td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;">${JSON.stringify(s.parameters || {})}</td>
                        <td>${s.status || 'active'}</td>
                        <td>
                            <button class="btn" onclick="editStrategy(${s.id})">ç¼–è¾‘</button>
                            <button class="btn" onclick="backtestStrategy(${s.id})">å›æµ‹</button>
                            <button class="btn" onclick="exportStrategy(${s.id})">å¯¼å‡º</button>
                            <button class="btn btn-danger" onclick="deleteStrategy(${s.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°ç­–ç•¥å¤±è´¥:', e);
                document.querySelector('#strategiesTable tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        // æ•°æ®åˆ†æï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshAnalytics() {
            const type = document.getElementById('analyticsType')?.value || 'overview';
            
            try {
                const res = await fetch(`${API_BASE}/analytics/${type}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                let content = '';
                
                if (type === 'overview') {
                    content = `
                        <div class="stats">
                            <div class="stat-box"><strong>${(data.total_profit || 0).toFixed(2)}</strong><span>æ€»åˆ©æ¶¦(USDT)</span></div>
                            <div class="stat-box"><strong>${(data.total_trades || 0)}</strong><span>æ€»äº¤æ˜“æ¬¡æ•°</span></div>
                            <div class="stat-box"><strong>${(data.win_rate || 0).toFixed(2)}%</strong><span>èƒœç‡</span></div>
                            <div class="stat-box"><strong>${(data.avg_profit_per_trade || 0).toFixed(2)}</strong><span>å¹³å‡æ¯ç¬”åˆ©æ¶¦</span></div>
                        </div>
                        <h3>æ”¶ç›Šè¶‹åŠ¿ï¼ˆè¿‘30å¤©ï¼‰</h3>
                        <div style="padding:20px;text-align:center;color:#999;border:1px solid #ddd;background:#f9f9f9;">
                            æ”¶ç›Šæ›²çº¿å›¾è¡¨åŒºåŸŸ<br>
                            <small>å»ºè®®é›†æˆ ECharts æˆ– Chart.js</small>
                        </div>
                    `;
                } else if (type === 'performance') {
                    content = `
                        <h3>æ€§èƒ½åˆ†æ</h3>
                        <table>
                            <thead><tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th></tr></thead>
                            <tbody>
                                <tr><td>å¹´åŒ–æ”¶ç›Šç‡</td><td>${(data.annual_return || 0).toFixed(2)}%</td></tr>
                                <tr><td>å¤æ™®æ¯”ç‡</td><td>${(data.sharpe_ratio || 0).toFixed(2)}</td></tr>
                                <tr><td>æœ€å¤§å›æ’¤</td><td>${(data.max_drawdown || 0).toFixed(2)}%</td></tr>
                                <tr><td>Sortinoæ¯”ç‡</td><td>${(data.sortino_ratio || 0).toFixed(2)}</td></tr>
                                <tr><td>Calmaræ¯”ç‡</td><td>${(data.calmar_ratio || 0).toFixed(2)}</td></tr>
                                <tr><td>æ³¢åŠ¨ç‡</td><td>${(data.volatility || 0).toFixed(2)}%</td></tr>
                            </tbody>
                        </table>
                    `;
                } else if (type === 'trend') {
                    content = `
                        <h3>è¶‹åŠ¿åˆ†æ</h3>
                        <table>
                            <thead><tr><th>äº¤æ˜“å¯¹</th><th>è¶‹åŠ¿æ–¹å‘</th><th>å¼ºåº¦</th><th>æ”¯æ’‘ä½</th><th>é˜»åŠ›ä½</th></tr></thead>
                            <tbody>
                                ${(data.trends || []).map(t => `
                                    <tr>
                                        <td>${t.symbol || '-'}</td>
                                        <td class="${t.direction === 'bullish' ? 'profit-pos' : 'profit-neg'}">${t.direction || '-'}</td>
                                        <td>${t.strength || '-'}</td>
                                        <td>${t.support || '-'}</td>
                                        <td>${t.resistance || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
                
                document.getElementById('analyticsContent').innerHTML = content;
            } catch (e) {
                console.error('åˆ·æ–°åˆ†ææ•°æ®å¤±è´¥:', e);
                document.getElementById('analyticsContent').innerHTML = '<p style="text-align:center;padding:20px;">åŠ è½½å¤±è´¥</p>';
            }
        }
        
        // å®¡è®¡æ—¥å¿—ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshAuditLogs() {
            try {
                const userFilter = document.getElementById('auditUserFilter')?.value || '';
                const dateFilter = document.getElementById('auditDateFilter')?.value || '';
                const actionFilter = document.getElementById('auditActionFilter')?.value || '';
                
                let url = `${API_BASE}/audit-logs`;
                const params = new URLSearchParams();
                if (userFilter) params.append('user_id', userFilter);
                if (dateFilter) params.append('date', dateFilter);
                if (actionFilter) params.append('action_type', actionFilter);
                if (params.toString()) url += '?' + params.toString();
                
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const logs = await res.json();
                
                const tbody = document.querySelector('#auditLogsTable tbody');
                if (!logs || logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">æš‚æ— å®¡è®¡æ—¥å¿—</td></tr>';
                    return;
                }
                
                tbody.innerHTML = logs.map(l => `
                    <tr>
                        <td>${new Date(l.created_at).toLocaleString()}</td>
                        <td>${l.username || '-'}</td>
                        <td>${l.action || '-'}</td>
                        <td>${l.resource || '-'}</td>
                        <td>${l.ip_address || '-'}</td>
                        <td><button class="btn" onclick="viewAuditLogDetail(${l.id})">è¯¦æƒ…</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°å®¡è®¡æ—¥å¿—å¤±è´¥:', e);
                document.querySelector('#auditLogsTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        async function exportAuditLogs() {
            try {
                const res = await fetch(`${API_BASE}/audit-logs/export`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audit_logs_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    alert('å¯¼å‡ºæˆåŠŸ');
                } else {
                    alert('å¯¼å‡ºå¤±è´¥');
                }
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
        
        function filterAuditLogs() {
            refreshAuditLogs();
        }
        
        // æ—¥å¿—ç®¡ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshLogs() {
            try {
                const level = document.getElementById('logLevel')?.value || '';
                const module = document.getElementById('logModule')?.value || '';
                const keyword = document.getElementById('logKeyword')?.value || '';
                
                let url = `${API_BASE}/log-manager/logs`;
                const params = new URLSearchParams();
                if (level) params.append('level', level);
                if (module) params.append('module', module);
                if (keyword) params.append('keyword', keyword);
                if (params.toString()) url += '?' + params.toString();
                
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const logs = await res.json();
                
                if (!logs || logs.length === 0) {
                    document.getElementById('logsContainer').innerHTML = 'æš‚æ— æ—¥å¿—è®°å½•';
                    return;
                }
                
                document.getElementById('logsContainer').innerHTML = logs.map(l => 
                    `[${l.timestamp}] [${l.level}] [${l.module}] ${l.message}`
                ).join('\n');
            } catch (e) {
                console.error('åˆ·æ–°æ—¥å¿—å¤±è´¥:', e);
                document.getElementById('logsContainer').innerHTML = 'åŠ è½½å¤±è´¥';
            }
        }
        
        function filterLogs() {
            refreshLogs();
        }
        
        async function clearLogs() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) return;
            try {
                const res = await fetch(`${API_BASE}/log-manager/clear`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æ—¥å¿—å·²æ¸…ç©º');
                    refreshLogs();
                } else {
                    alert('æ¸…ç©ºå¤±è´¥');
                }
            } catch (e) {
                alert('æ¸…ç©ºå¤±è´¥: ' + e.message);
            }
        }
        
        async function archiveLogs() {
            try {
                const res = await fetch(`${API_BASE}/log-manager/archive`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('æ—¥å¿—å½’æ¡£æˆåŠŸ');
                } else {
                    alert('å½’æ¡£å¤±è´¥');
                }
            } catch (e) {
                alert('å½’æ¡£å¤±è´¥: ' + e.message);
            }
        }
        
        // é€šçŸ¥ç®¡ç†ï¼ˆå¢å¼ºç‰ˆï¼‰
        async function refreshNotifications() {
            try {
                const res = await fetch(`${API_BASE}/notifications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const notifications = await res.json();
                
                const tbody = document.querySelector('#notificationsTable tbody');
                if (!notifications || notifications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">æš‚æ— é€šçŸ¥é…ç½®</td></tr>';
                    return;
                }
                
                tbody.innerHTML = notifications.map(n => `
                    <tr>
                        <td>${n.channel || '-'}</td>
                        <td style="font-size:11px;max-width:300px;overflow:hidden;text-overflow:ellipsis;">${JSON.stringify(n.config || {})}</td>
                        <td>${n.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</td>
                        <td>
                            <button class="btn" onclick="testNotificationByChannel('${n.channel}')">æµ‹è¯•</button>
                            <button class="btn" onclick="editNotification('${n.id}')">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deleteNotification('${n.id}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('åˆ·æ–°é€šçŸ¥é…ç½®å¤±è´¥:', e);
                document.querySelector('#notificationsTable tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;">åŠ è½½å¤±è´¥</td></tr>';
            }
        }
        
        async function testNotification() {
            const channel = prompt('è¯·è¾“å…¥é€šçŸ¥æ¸ é“ï¼ˆemail/dingtalk/feishu/telegram/webhookï¼‰ï¼š');
            if (!channel) return;
            await testNotificationByChannel(channel);
        }
        
        async function testNotificationByChannel(channel) {
            try {
                const res = await fetch(`${API_BASE}/notifications/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ channel: channel })
                });
                if (res.ok) {
                    alert('æµ‹è¯•é€šçŸ¥å·²å‘é€');
                } else {
                    alert('å‘é€å¤±è´¥');
                }
            } catch (e) {
                alert('å‘é€å¤±è´¥: ' + e.message);
            }
        }
        
        // å¯¼å‡ºåŠŸèƒ½
        async function exportTrades() {
            alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        async function exportAuditLogs() {
            alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('backtestEndTime').value = today;
            document.getElementById('backtestStartTime').value = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
            
            // å°è¯•è¿æ¥WebSocket
            connectWebSocket();
        });
        
        // WebSocketå®æ—¶æ•°æ®
        let ws = null;
        let wsReconnectAttempts = 0;
        
        function connectWebSocket() {
            try {
                ws = new WebSocket('ws://localhost:8000/ws');
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    wsReconnectAttempts = 0;
                    
                    // è®¢é˜…æ‰€æœ‰æ•°æ®æµ
                    ws.send(JSON.stringify({
                        action: 'subscribe',
                        topics: ['bot_status', 'market_data', 'kline_data', 'trade_data', 'account_update']
                    }));
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('WebSocket message parse error:', e);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    // å°è¯•é‡è¿
                    if (wsReconnectAttempts < 5) {
                        wsReconnectAttempts++;
                        setTimeout(connectWebSocket, 5000);
                    }
                };
            } catch (e) {
                console.error('WebSocket connection failed:', e);
            }
        }
        
        function handleWebSocketMessage(data) {
            switch (data.topic) {
                case 'bot_status':
                    updateBotStatus(data.data);
                    break;
                case 'market_data':
                    updateMarketData(data.data);
                    break;
                case 'trade_data':
                    addNewTrade(data.data);
                    break;
                case 'account_update':
                    updateAccountInfo(data.data);
                    break;
            }
        }
        
        function updateBotStatus(botData) {
            // æ›´æ–°æœºå™¨äººçŠ¶æ€
            if (botData && botData.bot_id) {
                const statusCell = document.querySelector(`#botsTable tbody tr[data-bot-id="${botData.bot_id}"] .status-cell`);
                if (statusCell) {
                    statusCell.textContent = botData.status;
                    statusCell.className = botData.status === 'running' ? 'status-running' : 'status-stopped';
                }
            }
        }
        
        function addNewTrade(tradeData) {
            // æ·»åŠ æ–°äº¤æ˜“è®°å½•åˆ°è¡¨æ ¼
            if (tradeData) {
                const tbody = document.querySelector('#recentTrades tbody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${new Date().toLocaleString()}</td>
                    <td>${tradeData.bot_name || '-'}</td>
                    <td>${tradeData.symbol || '-'}</td>
                    <td>${tradeData.side || '-'}</td>
                    <td>${tradeData.price || '-'}</td>
                    <td>${tradeData.amount || '-'}</td>
                    <td class="${tradeData.profit >= 0 ? 'profit-pos' : 'profit-neg'}">${tradeData.profit || '-'}</td>
                `;
                tbody.insertBefore(newRow, tbody.firstChild);
                
                // ä¿æŒæœ€å¤š10æ¡è®°å½•
                while (tbody.children.length > 10) {
                    tbody.removeChild(tbody.lastChild);
                }
            }
        }
        
        function updateMarketData(marketData) {
            // æ›´æ–°å¸‚åœºæ•°æ®æ˜¾ç¤º
            console.log('Market data update:', marketData);
        }
        
        function updateAccountInfo(accountData) {
            // æ›´æ–°è´¦æˆ·ä¿¡æ¯
            if (accountData && document.getElementById('dashboardStats')) {
                // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ä»ªè¡¨ç›˜ä¸Šçš„è´¦æˆ·ä¿¡æ¯
            }
        }
        
        // é€šçŸ¥ç®¡ç†å‡½æ•°
        function showAddNotificationModal() {
            document.getElementById('addNotificationModal').classList.add('active');
            updateNotificationFields();
        }
        
        function updateNotificationFields() {
            const channel = document.getElementById('notificationChannel').value;
            
            // éšè—æ‰€æœ‰å­—æ®µ
            document.getElementById('notificationEmailFields').style.display = 'none';
            document.getElementById('notificationDingtalkFields').style.display = 'none';
            document.getElementById('notificationFeishuFields').style.display = 'none';
            document.getElementById('notificationTelegramFields').style.display = 'none';
            document.getElementById('notificationWebhookFields').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”å­—æ®µ
            switch (channel) {
                case 'email':
                    document.getElementById('notificationEmailFields').style.display = 'block';
                    break;
                case 'dingtalk':
                    document.getElementById('notificationDingtalkFields').style.display = 'block';
                    break;
                case 'feishu':
                    document.getElementById('notificationFeishuFields').style.display = 'block';
                    break;
                case 'telegram':
                    document.getElementById('notificationTelegramFields').style.display = 'block';
                    break;
                case 'webhook':
                    document.getElementById('notificationWebhookFields').style.display = 'block';
                    break;
            }
        }
        
        async function addNotification() {
            const channel = document.getElementById('notificationChannel').value;
            const config = {};
            
            // æ”¶é›†è§¦å‘äº‹ä»¶
            const events = [];
            document.querySelectorAll('#addNotificationModal input[type="checkbox"]:checked').forEach(cb => {
                events.push(cb.value);
            });
            
            // æ ¹æ®æ¸ é“æ”¶é›†é…ç½®
            switch (channel) {
                case 'email':
                    config.smtp_server = document.getElementById('smtpServer').value;
                    config.smtp_port = parseInt(document.getElementById('smtpPort').value);
                    config.sender_email = document.getElementById('senderEmail').value;
                    config.email_password = document.getElementById('emailPassword').value;
                    config.receiver_email = document.getElementById('receiverEmail').value;
                    break;
                case 'dingtalk':
                    config.webhook_url = document.getElementById('dingtalkWebhook').value;
                    config.secret = document.getElementById('dingtalkSecret').value;
                    break;
                case 'feishu':
                    config.webhook_url = document.getElementById('feishuWebhook').value;
                    break;
                case 'telegram':
                    config.bot_token = document.getElementById('telegramBotToken').value;
                    config.chat_id = document.getElementById('telegramChatId').value;
                    break;
                case 'webhook':
                    config.url = document.getElementById('webhookUrl').value;
                    try {
                        config.headers = JSON.parse(document.getElementById('webhookHeaders').value);
                    } catch (e) {
                        alert('Headersæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æ­£ç¡®çš„JSONæ ¼å¼');
                        return;
                    }
                    break;
            }
            
            try {
                const res = await fetch(`${API_BASE}/notifications`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        channel: channel,
                        config: config,
                        events: events,
                        enabled: true
                    })
                });
                
                if (res.ok) {
                    alert('é€šçŸ¥é…ç½®æ·»åŠ æˆåŠŸ');
                    closeModal('addNotificationModal');
                    refreshNotifications();
                } else {
                    alert('æ·»åŠ å¤±è´¥');
                }
            } catch (e) {
                alert('æ·»åŠ å¤±è´¥: ' + e.message);
            }
        }
        
        // ç­–ç•¥ç®¡ç†å‡½æ•°
        function showCreateStrategyModal() {
            document.getElementById('createStrategyModal').classList.add('active');
        }
        
        async function createStrategy() {
            const data = {
                name: document.getElementById('strategyName').value,
                type: document.getElementById('strategyType').value,
                description: document.getElementById('strategyDescription').value,
                parameters: JSON.parse(document.getElementById('strategyParameters').value || '{}'),
                code: document.getElementById('strategyCode').value
            };
            
            try {
                const res = await fetch(`${API_BASE}/strategies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('ç­–ç•¥åˆ›å»ºæˆåŠŸ');
                    closeModal('createStrategyModal');
                    refreshStrategies();
                } else {
                    alert('åˆ›å»ºå¤±è´¥');
                }
            } catch (e) {
                alert('åˆ›å»ºå¤±è´¥: ' + e.message);
            }
        }
        
        async function editStrategy(strategyId) {
            alert(`ç¼–è¾‘ç­–ç•¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œç­–ç•¥ID: ${strategyId}`);
        }
        
        async function deleteStrategy(strategyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç­–ç•¥å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/strategies/${strategyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('ç­–ç•¥å·²åˆ é™¤');
                    refreshStrategies();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }
        
        async function exportStrategy(strategyId) {
            alert(`å¯¼å‡ºç­–ç•¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œç­–ç•¥ID: ${strategyId}`);
        }
        
        async function backtestStrategy(strategyId) {
            alert(`å›æµ‹ç­–ç•¥åŠŸèƒ½å¼€å‘ä¸­ï¼Œç­–ç•¥ID: ${strategyId}`);
        }
        
        // ç³»ç»Ÿè®¾ç½®å‡½æ•°
        async function saveSettings() {
            const settings = {
                system_name: document.getElementById('systemName').value,
                timezone: document.getElementById('timezone').value,
                default_exchange: document.getElementById('defaultExchange').value,
                default_symbol: document.getElementById('defaultSymbol').value,
                max_position: parseFloat(document.getElementById('maxPosition').value),
                max_daily_loss: parseFloat(document.getElementById('maxDailyLoss').value),
                global_stop_loss: parseFloat(document.getElementById('globalStopLoss').value) / 100,
                global_take_profit: parseFloat(document.getElementById('globalTakeProfit').value) / 100
            };
            
            try {
                const res = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(settings)
                });
                
                if (res.ok) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥');
                }
            } catch (e) {
                alert('ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }
        
        async function resetSettings() {
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿ')) return;
            
            document.getElementById('systemName').value = 'åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ';
            document.getElementById('timezone').value = 'Asia/Shanghai';
            document.getElementById('defaultExchange').value = 'binance';
            document.getElementById('defaultSymbol').value = 'BTC/USDT';
            document.getElementById('maxPosition').value = '10000';
            document.getElementById('maxDailyLoss').value = '1000';
            document.getElementById('globalStopLoss').value = '5';
            document.getElementById('globalTakeProfit').value = '10';
            
            alert('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®');
        }
        
        async function exportSettings() {
            try {
                const res = await fetch(`${API_BASE}/settings/export`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `settings_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    alert('å¯¼å‡ºæˆåŠŸ');
                } else {
                    alert('å¯¼å‡ºå¤±è´¥');
                }
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
        
        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const res = await fetch(`${API_BASE}/settings/import`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` },
                        body: formData
                    });
                    
                    if (res.ok) {
                        alert('å¯¼å…¥æˆåŠŸï¼Œè¯·åˆ·æ–°é¡µé¢');
                        location.reload();
                    } else {
                        alert('å¯¼å…¥å¤±è´¥');
                    }
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥: ' + err.message);
                }
            };
            input.click();
        }
        
        async function getOptimizationSuggestions() {
            try {
                const res = await fetch(`${API_BASE}/optimize/suggestions`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                
                const suggestions = data.suggestions || [];
                if (suggestions.length > 0) {
                    document.getElementById('optimizationSuggestions').innerHTML = `
                        <ul style="margin-left:20px;">
                            ${suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    document.getElementById('optimizationSuggestions').innerHTML = '<p>ç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼Œæš‚æ— ä¼˜åŒ–å»ºè®®</p>';
                }
            } catch (e) {
                document.getElementById('optimizationSuggestions').innerHTML = '<p>è·å–ä¼˜åŒ–å»ºè®®å¤±è´¥</p>';
            }
        }
        
        // å…¶ä»–è¾…åŠ©å‡½æ•°
        async function downloadLogs() {
            try {
                const res = await fetch(`${API_BASE}/log-manager/download`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logs_${new Date().toISOString().split('T')[0]}.txt`;
                    a.click();
                    alert('ä¸‹è½½æˆåŠŸ');
                } else {
                    alert('ä¸‹è½½å¤±è´¥');
                }
            } catch (e) {
                alert('ä¸‹è½½å¤±è´¥: ' + e.message);
            }
        }
        
        function viewBotStatus(botId) {
            alert(`æŸ¥çœ‹æœºå™¨äººçŠ¶æ€åŠŸèƒ½å¼€å‘ä¸­ï¼Œæœºå™¨äººID: ${botId}`);
        }
        
        function viewOrderDetail(orderId) {
            alert(`æŸ¥çœ‹è®¢å•è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­ï¼Œè®¢å•ID: ${orderId}`);
        }
        
        function viewAuditLogDetail(logId) {
            alert(`æŸ¥çœ‹å®¡è®¡æ—¥å¿—è¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ—¥å¿—ID: ${logId}`);
        }
        
        async function testExchange(exchangeId) {
            try {
                const res = await fetch(`${API_BASE}/exchange/${exchangeId}/test`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    alert('è¿æ¥æµ‹è¯•æˆåŠŸï¼');
                } else {
                    alert('è¿æ¥æµ‹è¯•å¤±è´¥');
                }
            } catch (e) {
                alert('æµ‹è¯•å¤±è´¥: ' + e.message);
            }
        }
        
        async function deleteExchange(exchangeId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº¤æ˜“æ‰€é…ç½®å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/exchange/${exchangeId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('äº¤æ˜“æ‰€å·²åˆ é™¤');
                    refreshExchanges();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }
        
        function testAllExchanges() {
            alert('æ‰¹é‡æµ‹è¯•è¿æ¥åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        async function deleteBackup(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å¤‡ä»½æ–‡ä»¶ ${filename} å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`${API_BASE}/database-manager/backup/${filename}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('å¤‡ä»½å·²åˆ é™¤');
                    refreshDatabase();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }
        
        function editUser(userId) {
            alert(`ç¼–è¾‘ç”¨æˆ·åŠŸèƒ½å¼€å‘ä¸­ï¼Œç”¨æˆ·ID: ${userId}`);
        }
        
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/rbac/users/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('ç”¨æˆ·å·²åˆ é™¤');
                    refreshUsers();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }
        
        function restoreBackup(filename) {
            if (!confirm(`ç¡®å®šè¦ä»å¤‡ä»½ ${filename} æ¢å¤æ•°æ®åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) return;
            alert('æ•°æ®åº“æ¢å¤åŠŸèƒ½å¼€å‘ä¸­');
        }
        
        function analyzeDatabase() {
            alert('æ•°æ®åº“åˆ†æåŠŸèƒ½å¼€å‘ä¸­');
        }
        
        async function exportAuditLogsJSON() {
            try {
                const res = await fetch(`${API_BASE}/audit-logs/export?format=json`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audit_logs_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    alert('å¯¼å‡ºæˆåŠŸ');
                } else {
                    alert('å¯¼å‡ºå¤±è´¥');
                }
            } catch (e) {
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        }
        
        function editNotification(notificationId) {
            alert(`ç¼–è¾‘é€šçŸ¥é…ç½®åŠŸèƒ½å¼€å‘ä¸­ï¼ŒID: ${notificationId}`);
        }
        
        async function deleteNotification(notificationId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé€šçŸ¥é…ç½®å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`${API_BASE}/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    alert('é€šçŸ¥é…ç½®å·²åˆ é™¤');
                    refreshNotifications();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥: ' + e.message);
            }
        }
    </script>
</body>
</html>
